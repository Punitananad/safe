{% extends "base_new_journal.html" %}

{% block title %}AI Trading Assistant - Trading Journal{% endblock %}

{% block extra_css %}
<style>
  .quick-action-card {
    background: var(--card);
    border: 1px solid #334155;
    border-radius: 0.75rem;
    padding: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .quick-action-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    border-color: var(--accent);
  }
  
  .chat-container {
    background: var(--card);
    border: 1px solid #334155;
    border-radius: 1rem;
    height: 600px;
    display: flex;
    flex-direction: column;
  }
  
  .chat-header {
    padding: 1rem;
    border-bottom: 1px solid #334155;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .chat-input-area {
    padding: 1rem;
    border-top: 1px solid #334155;
  }
  
  .message {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .message.user {
    flex-direction: row-reverse;
  }
  
  .message-avatar {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .bot-avatar {
    background: var(--accent);
  }
  
  .user-avatar {
    background: #0ea5e9;
  }
  
  .message-content {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    line-height: 1.5;
  }
  
  .bot-message {
    background: #1e293b;
    border: 1px solid #334155;
  }
  
  .user-message {
    background: var(--accent);
    color: white;
  }
  
  .chat-input {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    color: #e6eef6;
    width: 100%;
  }
  
  .chat-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 0.2rem rgba(14, 165, 164, 0.25);
  }
  
  .status-indicator {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    background: #10b981;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .chart-container {
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 0.75rem;
  }
  
  .metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    text-align: center;
  }
  
  .metric-value {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
  }
  
  .metric-label {
    font-size: 0.75rem;
    color: var(--muted);
  }
  
  .symbol-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .symbol-positive {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
  }
  
  .symbol-negative {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }
  
  .pnl-positive { color: #10b981; }
  .pnl-negative { color: #ef4444; }
  
  .typing-indicator {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.75rem 1rem;
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 1rem;
    max-width: fit-content;
  }
  
  .typing-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    background: var(--muted);
    animation: typing 1.4s infinite ease-in-out;
  }
  
  .typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .typing-dot:nth-child(2) { animation-delay: -0.16s; }
  
  @keyframes typing {
    0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold">AI Trading Assistant</h1>
      <p class="muted">Get insights, analysis, and advice on your trading performance</p>
    </div>
    <button id="exportChatBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-teal-600 to-sky-600 text-white rounded-lg hover:from-teal-700 hover:to-sky-700 transition-all">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      Export Chat
    </button>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Quick Actions Sidebar -->
    <div class="lg:col-span-1 space-y-4">
      <div class="quick-action-card">
        <h3 class="text-lg font-semibold mb-4">Quick Questions</h3>
        <div class="space-y-2">
          <button class="quick-prompt w-full text-left p-3 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm" 
                  data-prompt="Summarize my last 30 days trading performance">
            <svg class="w-4 h-4 inline mr-2 text-sky-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            Summarize last 30 days
          </button>
          
          <button class="quick-prompt w-full text-left p-3 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm" 
                  data-prompt="What is my best performing symbol?">
            <svg class="w-4 h-4 inline mr-2 text-yellow-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
            </svg>
            Best performing symbol
          </button>
          
          <button class="quick-prompt w-full text-left p-3 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm" 
                  data-prompt="Show me equity curve insights">
            <svg class="w-4 h-4 inline mr-2 text-emerald-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
            </svg>
            Equity curve insight
          </button>
          
          <button class="quick-prompt w-full text-left p-3 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm" 
                  data-prompt="Analyze my risk-to-reward ratio">
            <svg class="w-4 h-4 inline mr-2 text-purple-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
            </svg>
            Risk-to-Reward analysis
          </button>
          
          <button class="quick-prompt w-full text-left p-3 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm" 
                  data-prompt="Give me trading advice to improve">
            <svg class="w-4 h-4 inline mr-2 text-orange-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
            Trading advice
          </button>
          
          <button class="quick-prompt w-full text-left p-3 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm" 
                  data-prompt="How are my challenges progressing?">
            <svg class="w-4 h-4 inline mr-2 text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m6-4v16H3V4h18z"/>
            </svg>
            Challenge progress
          </button>
        </div>
      </div>

      <!-- AI Status -->
      <div class="quick-action-card">
        <h3 class="text-lg font-semibold mb-2">AI Status</h3>
        <div class="flex items-center text-sm mb-2">
          <div class="status-indicator mr-2"></div>
          <span class="text-emerald-400">Online & Ready</span>
        </div>
        <p class="text-xs muted">Ask me anything about your trading performance!</p>
      </div>
    </div>

    <!-- Chat Interface -->
    <div class="lg:col-span-3">
      <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
          <div class="flex items-center gap-3">
            <div class="message-avatar bot-avatar">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold">Trading Assistant</h3>
              <p class="text-xs muted">AI-powered trading insights</p>
            </div>
          </div>
          <button id="clearChatBtn" class="px-3 py-1 text-sm bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Clear
          </button>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-messages">
          <!-- Welcome Message -->
          <div class="message">
            <div class="message-avatar bot-avatar">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
            </div>
            <div class="message-content bot-message">
              ðŸ‘‹ Hello! I'm your AI trading assistant. I can help you analyze your performance, identify patterns, and provide personalized advice. What would you like to know about your trading?
            </div>
          </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-area">
          <div class="flex gap-2">
            <input type="text" id="chatInput" placeholder="Ask me about your trading performance..." class="chat-input">
            <button id="sendBtn" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
              </svg>
            </button>
          </div>
          <div class="flex items-center mt-2 text-xs muted">
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>Press Enter to send â€¢ Try asking about summaries, symbols, or advice</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-[color:var(--card)] border border-slate-600 rounded-lg p-6 flex items-center">
    <div class="w-8 h-8 border-2 border-teal-600 border-t-transparent rounded-full animate-spin mr-3"></div>
    <span>AI is thinking...</span>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const loadingModal = document.getElementById('loadingModal');
  let messageId = 0;

  // Event listeners
  sendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  document.getElementById('clearChatBtn').addEventListener('click', clearChat);
  document.getElementById('exportChatBtn').addEventListener('click', exportChat);

  // Quick prompt buttons
  document.querySelectorAll('.quick-prompt').forEach(btn => {
    btn.addEventListener('click', () => {
      chatInput.value = btn.dataset.prompt;
      sendMessage();
    });
  });

  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    // Add user message to chat
    addMessage(message, 'user');
    chatInput.value = '';
    sendBtn.disabled = true;
    
    // Show typing indicator
    showTypingIndicator();

    try {
      const response = await fetch('/calculatentrade_journal/api/ai_chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
      });

      const data = await response.json();
      
      // Remove typing indicator
      hideTypingIndicator();
      
      if (response.ok) {
        // Add bot response
        addMessage(data.reply, 'bot', data);
      } else {
        addMessage('Sorry, I encountered an error. Please try again.', 'bot');
      }
    } catch (error) {
      console.error('Chat error:', error);
      hideTypingIndicator();
      addMessage('Sorry, I\'m having trouble connecting. Please try again.', 'bot');
    } finally {
      sendBtn.disabled = false;
      chatInput.focus();
    }
  }

  function addMessage(content, sender, data = null) {
    messageId++;
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messageDiv.id = `message-${messageId}`;

    if (sender === 'user') {
      messageDiv.innerHTML = `
        <div class="message-avatar user-avatar">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        </div>
        <div class="message-content user-message">
          ${escapeHtml(content)}
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="message-avatar bot-avatar">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
        </div>
        <div class="message-content bot-message">
          ${formatBotMessage(content)}
          ${data && data.chart_type ? createChart(data) : ''}
        </div>
      `;
    }

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
      <div class="message-avatar bot-avatar">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
      </div>
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
      typingIndicator.remove();
    }
  }

  function formatBotMessage(content) {
    return content
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/â€¢/g, 'â€¢')
      .replace(/(\d+)\./g, '<strong>$1.</strong>')
      .replace(/(â‚¹[\d,]+\.?\d*)/g, '<span class="font-mono text-teal-400">$1</span>')
      .replace(/(\d+\.?\d*%)/g, '<span class="font-mono text-sky-400">$1</span>');
  }

  function createChart(data) {
    if (!data.chart_type || !data.data) return '';

    const chartId = `chart-${messageId}`;
    let chartHtml = `<div class="chart-container">`;

    switch (data.chart_type) {
      case 'summary':
        chartHtml += `
          <div class="metric-grid">
            <div>
              <div class="metric-value ${data.data.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                â‚¹${data.data.pnl.toLocaleString()}
              </div>
              <div class="metric-label">Total P&L</div>
            </div>
            <div>
              <div class="metric-value text-sky-400">${data.data.trades}</div>
              <div class="metric-label">Trades</div>
            </div>
            <div>
              <div class="metric-value text-purple-400">${data.data.win_rate.toFixed(1)}%</div>
              <div class="metric-label">Win Rate</div>
            </div>
          </div>
        `;
        break;

      case 'symbols':
        chartHtml += `<div class="space-y-2">`;
        if (data.data.best) {
          chartHtml += `
            <div class="symbol-item symbol-positive">
              <span class="font-medium">${data.data.best.symbol}</span>
              <span class="pnl-positive font-bold">â‚¹${data.data.best.pnl.toLocaleString()}</span>
            </div>
          `;
        }
        if (data.data.worst) {
          chartHtml += `
            <div class="symbol-item symbol-negative">
              <span class="font-medium">${data.data.worst.symbol}</span>
              <span class="pnl-negative font-bold">â‚¹${data.data.worst.pnl.toLocaleString()}</span>
            </div>
          `;
        }
        chartHtml += `</div>`;
        break;

      case 'risk_reward':
        const ratio = typeof data.data.ratio === 'string' ? data.data.ratio : `1:${data.data.ratio.toFixed(2)}`;
        chartHtml += `
          <div class="metric-grid">
            <div>
              <div class="metric-value pnl-positive">â‚¹${data.data.avg_win.toLocaleString()}</div>
              <div class="metric-label">Avg Win</div>
            </div>
            <div>
              <div class="metric-value pnl-negative">â‚¹${data.data.avg_loss.toLocaleString()}</div>
              <div class="metric-label">Avg Loss</div>
            </div>
          </div>
          <div class="text-center mt-3">
            <div class="metric-value text-teal-400">${ratio}</div>
            <div class="metric-label">Risk:Reward Ratio</div>
          </div>
        `;
        break;

      default:
        return '';
    }

    chartHtml += '</div>';
    return chartHtml;
  }

  function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
      chatMessages.innerHTML = `
        <div class="message">
          <div class="message-avatar bot-avatar">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <div class="message-content bot-message">
            ðŸ‘‹ Hello! I'm your AI trading assistant. I can help you analyze your performance, identify patterns, and provide personalized advice. What would you like to know about your trading?
          </div>
        </div>
      `;
      messageId = 0;
    }
  }

  function exportChat() {
    const messages = Array.from(chatMessages.children);
    let chatText = 'Trading Assistant Chat Export\n';
    chatText += '='.repeat(40) + '\n\n';

    messages.forEach((msg, index) => {
      const isBot = msg.querySelector('.bot-avatar');
      const content = msg.querySelector('.message-content');
      
      if (content && !msg.id.includes('typing')) {
        const sender = isBot ? 'AI Assistant' : 'You';
        const text = content.textContent.trim();
        chatText += `${sender}: ${text}\n\n`;
      }
    });

    const blob = new Blob([chatText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `trading-chat-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Focus on input
  chatInput.focus();
});
</script>
{% endblock %}