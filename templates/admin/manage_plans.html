{% extends "admin/admin_base.html" %}

{% block title %}Manage Subscription Plans{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Manage Subscription Plans</h2>
                <button class="btn btn-success" onclick="showCreatePlanModal()">
                    <i class="fa fa-plus"></i> Create New Plan
                </button>
            </div>
            
            <!-- Plans Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Display Name</th>
                                    <th>Price</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Features</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plan in plans %}
                                <tr>
                                    <td>{{ plan.id }}</td>
                                    <td><code>{{ plan.name }}</code></td>
                                    <td>{{ plan.display_name }}</td>
                                    <td>₹{{ "%.2f"|format(plan.price / 100) }}</td>
                                    <td>{{ plan.duration_days }} days</td>
                                    <td>
                                        <span class="badge badge-{% if plan.is_active %}success{% else %}danger{% endif %}">
                                            {{ 'Active' if plan.is_active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if plan.features %}
                                        <button class="btn btn-sm btn-info" onclick="showFeatures({{ plan.features|tojson }})">
                                            View Features ({{ plan.features|length }})
                                        </button>
                                        {% else %}
                                        <span class="text-muted">No features</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ plan.created_at.strftime('%Y-%m-%d') if plan.created_at else 'N/A' }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-warning" onclick="editPlan({{ plan.id }}, {{ plan.to_dict()|tojson }})">
                                                Edit
                                            </button>
                                            <button class="btn btn-sm btn-{% if plan.is_active %}danger{% else %}success{% endif %}" 
                                                    onclick="togglePlanStatus({{ plan.id }}, {{ plan.is_active|tojson }})">
                                                {% if plan.is_active %}Deactivate{% else %}Activate{% endif %}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Plan Modal -->
<div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="planModalTitle">Create New Plan</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Plan Name (Code):</label>
                                <input type="text" id="planName" class="form-control" required 
                                       placeholder="e.g., monthly, yearly">
                                <small class="text-muted">Used internally, no spaces or special characters</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Display Name:</label>
                                <input type="text" id="planDisplayName" class="form-control" required 
                                       placeholder="e.g., Monthly Plan">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Price (₹):</label>
                                <input type="number" id="planPrice" class="form-control" required min="0" step="0.01">
                                <small class="text-muted">Enter amount in rupees (e.g., 25.00)</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Duration (Days):</label>
                                <input type="number" id="planDuration" class="form-control" required min="1">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Features:</label>
                        <textarea id="planFeatures" class="form-control" rows="4" 
                                  placeholder="Enter features, one per line"></textarea>
                        <small class="text-muted">Enter each feature on a new line</small>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="planActive" class="form-check-input" checked>
                            <label class="form-check-label" for="planActive">
                                Active Plan
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="savePlan()">Save Plan</button>
            </div>
        </div>
    </div>
</div>

<!-- Features Modal -->
<div class="modal fade" id="featuresModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Plan Features</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <ul id="featuresList" class="list-group">
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let editingPlanId = null;

function showCreatePlanModal() {
    editingPlanId = null;
    document.getElementById('planModalTitle').textContent = 'Create New Plan';
    document.getElementById('planForm').reset();
    document.getElementById('planId').value = '';
    document.getElementById('planActive').checked = true;
    $('#planModal').modal('show');
}

function editPlan(planId, planData) {
    editingPlanId = planId;
    document.getElementById('planModalTitle').textContent = 'Edit Plan';
    document.getElementById('planId').value = planId;
    document.getElementById('planName').value = planData.name;
    document.getElementById('planDisplayName').value = planData.display_name;
    document.getElementById('planPrice').value = planData.price / 100; // Convert paise to rupees
    document.getElementById('planDuration').value = planData.duration_days;
    document.getElementById('planFeatures').value = planData.features ? planData.features.join('\n') : '';
    document.getElementById('planActive').checked = planData.is_active;
    $('#planModal').modal('show');
}

function savePlan() {
    const planId = document.getElementById('planId').value;
    const isEdit = planId !== '';
    
    const features = document.getElementById('planFeatures').value
        .split('\n')
        .map(f => f.trim())
        .filter(f => f.length > 0);
    
    const planData = {
        name: document.getElementById('planName').value,
        display_name: document.getElementById('planDisplayName').value,
        price: Math.round(parseFloat(document.getElementById('planPrice').value) * 100), // Convert to paise
        duration_days: parseInt(document.getElementById('planDuration').value),
        features: features,
        is_active: document.getElementById('planActive').checked
    };
    
    const url = isEdit ? `/admin/subscription/plans/${planId}/update` : '/admin/subscription/plans/create';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(planData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            $('#planModal').modal('hide');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function togglePlanStatus(planId, currentStatus) {
    const action = currentStatus ? 'deactivate' : 'activate';
    if (confirm(`Are you sure you want to ${action} this plan?`)) {
        fetch(`/admin/subscription/plans/${planId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                is_active: !currentStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function showFeatures(features) {
    const featuresList = document.getElementById('featuresList');
    featuresList.innerHTML = '';
    
    features.forEach(feature => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerHTML = `<i class="fa fa-check text-success"></i> ${feature}`;
        featuresList.appendChild(li);
    });
    
    $('#featuresModal').modal('show');
}
</script>
{% endblock %}