{% extends "base.html" %}

{% block title %}Swing Position Manager — {{ symbol }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .container{max-width:1400px;margin:0 auto;padding:1rem}
    header{display:flex;justify-content:space-between;align-items:center;padding:1.5rem;background:var(--card);border-radius:1rem;box-shadow:0 4px 15px rgba(0,0,0,.3);margin-bottom:1.5rem;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
    .stock-info{display:flex;align-items:center}
    .stock-icon{width:50px;height:50px;background:linear-gradient(135deg,#4e54c8,#8f94fb);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:15px;font-size:24px}
    .stock-details h1{color:#e6eef6;font-size:1.75rem}
    .stock-details p{color:var(--muted)}
    .live-price{text-align:right}
    .price{font-size:2rem;font-weight:700;color:#e6eef6}
    .change{font-size:1.125rem;font-weight:700}
    .positive{color:#4cd964}.negative{color:#ff3b30}
    
    /* 50-50 Layout */
    .dashboard{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem}
    @media (max-width:768px){.dashboard{grid-template-columns:1fr}}
    
    .card{background:var(--card);border-radius:1rem;padding:1.5rem;box-shadow:0 4px 15px rgba(0,0,0,.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);transition:all 0.3s ease;height:fit-content}
    .card h2{color:#e6eef6;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:2px solid rgba(255,255,255,.2);display:flex;align-items:center;gap:0.75rem}

    .stats{display:grid;gap:1rem;text-align:center}
    .stat-item{padding:1rem;background:rgba(255,255,255,.05);border-radius:0.5rem}
    .stat-value{font-size:1.5rem;font-weight:700;color:#e6eef6}
    .stat-label{font-size:0.875rem;color:var(--muted)}

    .actions{display:flex;gap:0.75rem;justify-content:center}
    button{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041024;border:none;padding:0.75rem 1.25rem;border-radius:0.5rem;cursor:pointer;font-size:0.875rem;font-weight:600;transition:all 0.3s ease}
    button:hover{background:linear-gradient(135deg,#3a3f99,#6f73d9);transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3)}
    .btn-primary-large{background:linear-gradient(135deg,#4cd964,#2fb344);color:#fff;padding:12px 24px;font-size:16px;font-weight:700;border-radius:8px;box-shadow:0 4px 15px rgba(76,217,100,0.3);transition:all 0.3s ease}
    .btn-primary-large:hover{background:linear-gradient(135deg,#2fb344,#1e7e34);transform:translateY(-3px);box-shadow:0 6px 20px rgba(76,217,100,0.4)}
    .btn-sell-large{background:linear-gradient(135deg,#ff3b30,#dc2626);color:#fff;padding:12px 24px;font-size:16px;font-weight:700;border-radius:8px;box-shadow:0 4px 15px rgba(255,59,48,0.3);transition:all 0.3s ease}
    .btn-sell-large:hover{background:linear-gradient(135deg,#dc2626,#b91c1c);transform:translateY(-3px);box-shadow:0 6px 20px rgba(255,59,48,0.4)}
    .btn-sell{background:linear-gradient(90deg,#f87171,#f43f5e);color:#041024}.btn-sell:hover{background:linear-gradient(90deg,#e73c64,#e64527)}
    .btn-ai{background:linear-gradient(90deg,#10b981,#06b6d4);color:#041024}.btn-ai:hover{background:linear-gradient(90deg,#009a7a,#0891b2)}
    .btn-back{background:linear-gradient(90deg,var(--accent-2),#3b82f6);color:#041024}.btn-back:hover{background:linear-gradient(90deg,#1f67e6,#2563eb)}

    .hidden{display:none}
    .history-entry{background:rgba(255,255,255,.1);border-left:4px solid #4e54c8;border-radius:8px;padding:12px;margin-bottom:10px}
    .tiny-link{font-size:0.75rem;color:var(--accent);background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.1);padding:0.25rem 0.5rem;border-radius:0.375rem;cursor:pointer;transition:all 0.3s ease}
    .tiny-link:hover{background:rgba(255,255,255,.3);transform:translateY(-1px)}
    #deleteTemplateBtn{background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)}
    #deleteTemplateBtn:hover{background:rgba(255,59,48,.3)}
    #saveTemplateBtn{background:rgba(76,217,100,.2);color:#4cd964;border:1px solid rgba(76,217,100,.3)}
    #saveTemplateBtn:hover{background:rgba(76,217,100,.3)}

    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
    .form-group{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:0.5rem;padding:0.75rem}
    .form-group label{display:block;font-weight:600;color:#ddd;margin-bottom:6px}
    .form-group input[type="number"],.form-group input[type="text"]{width:100%;padding:0.75rem;border:1px solid rgba(255,255,255,.2);border-radius:0.5rem;background:rgba(0,0,0,.2);color:#e6eef6}

    .trade-badge{font-weight:700;padding:8px 12px;border-radius:999px;display:inline-block}
    .badge-buy{background:rgba(76,217,100,.2);color:#4cd964;border:1px solid rgba(76,217,100,.3)}
    .badge-sell{background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)}

    .tiles{grid-template-columns:repeat(4,1fr)}
    @media (max-width:900px){ .tiles{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:520px){ .tiles{grid-template-columns:1fr} }

    .select{width:100%;padding:0.625rem 0.75rem;border:1px solid rgba(255,255,255,.3);border-radius:0.375rem;background:rgba(26,26,46,0.9);color:#e6eef6;backdrop-filter:blur(10px);box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .selector-row{display:flex;gap:12px;align-items:center}
    .split-options{display:flex;flex-wrap:wrap;gap:14px;margin-top:14px}
    .split-option{flex:1;min-width:220px;background:rgba(255,255,255,.1);border-radius:10px;padding:16px;border:1px solid rgba(255,255,255,.1);text-align:center;cursor:pointer;transition:all 0.3s ease}
    .split-option:hover{transform:translateY(-5px);box-shadow:0 5px 15px rgba(0,0,0,.3);background:rgba(255,255,255,.15)}
    .split-option h3{color:#fff;margin-bottom:8px;font-size:1rem}
    .split-option p{color:#aaa;font-size:.9rem;margin-bottom:10px}
    .part{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:16px;margin-bottom:12px}
    .part-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .input-group{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .input-box{flex:1;min-width:200px}
    .input-box label{display:block;margin-bottom:6px;font-weight:600;color:#ddd}
    .input-box input{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;background:rgba(0,0,0,.2);color:#fff}
    .live-result{background:rgba(0,0,0,.3);border:1px dashed rgba(255,255,255,.2);padding:10px;border-radius:8px;font-family:monospace;color:#fff}
    .adv-row{display:flex;align-items:center;gap:10px;margin:6px 0 12px}
    .status-pill{font-size:12px;border:1px solid rgba(78,84,200,.3);background:rgba(78,84,200,.2);color:#8f94fb;padding:4px 8px;border-radius:999px}

    /* AI Mode */
    .ai-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media (max-width:900px){.ai-grid{grid-template-columns:1fr}}
    .ai-console{max-height:180px;overflow:auto;background:rgba(15,22,38,.8);color:#e6eeff;border:1px solid rgba(229,231,235,.2);border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px}
    .ai-bar{display:flex;align-items:center;gap:8px;padding:10px;margin-top:8px;background:rgba(238,242,255,.1);border-radius:10px;border:1px dashed rgba(203,213,255,.3)}
    .dot{width:8px;height:8px;border-radius:50%;background:#4e54c8;animation:pulse 1.6s infinite}
    @keyframes pulse{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);text-align:left}
    th{background:rgba(255,255,255,.1);color:#fff}
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;display:inline-block}
    .pill.good{background:rgba(233,249,241,.2);color:#4cd964;border:1px solid rgba(185,240,212,.3)}
    .pill.warn{background:rgba(255,247,214,.2);color:#ffcc00;border:1px solid rgba(255,232,161,.3)}
    
    /* AI Thinking Animation */
    .fa-brain {
      animation: brain-pulse 1.5s ease-in-out infinite;
    }
    @keyframes brain-pulse {
      0%, 100% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.1); opacity: 1; }
    }
    
    /* Futuristic elements */
    .glow-text {text-shadow: 0 0 10px rgba(143, 148, 251, 0.7);}
    .circuit-bg {position: relative; overflow: hidden;}
    .circuit-bg::before {content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(circle at 10% 20%, rgba(78, 84, 200, 0.1) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(143, 148, 251, 0.1) 0%, transparent 20%); pointer-events: none;}
    
    footer {text-align: center; margin-top: 20px; color: #aaa; font-size: 14px;}
    
    /* Advanced Risk Calculator Styles */
    .risk-presets {display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;}
    .preset-btn {padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: #fff; cursor: pointer; transition: all 0.3s ease; font-size: 14px;}
    .preset-btn:hover {background: rgba(78, 84, 200, 0.3); transform: translateY(-2px);}
    .preset-btn.active {background: rgba(78, 84, 200, 0.5); border-color: #8f94fb;}
    
    .risk-controls {display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;}
    @media (max-width: 768px) {.risk-controls {grid-template-columns: 1fr;}}
    
    .control-group {background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);}
    .control-group label {display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-weight: 600; color: #ddd; font-size: 14px;}
    
    .slider-input-combo {display: flex; gap: 12px; align-items: center;}
    .slider-input-combo input[type="range"] {flex: 2; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none; -webkit-appearance: none;}
    .slider-input-combo input[type="range"]::-webkit-slider-thumb {-webkit-appearance: none; width: 18px; height: 18px; background: linear-gradient(135deg, #4e54c8, #8f94fb); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3);}
    .slider-input-combo input[type="range"]::-moz-range-thumb {width: 18px; height: 18px; background: linear-gradient(135deg, #4e54c8, #8f94fb); border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.3);}
    .slider-input-combo input[type="number"] {flex: 1; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; text-align: center; font-weight: 600;}
    
    .risk-badge {padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;}
    .risk-badge.conservative {background: rgba(76, 217, 100, 0.2); color: #4cd964;}
    .risk-badge.balanced {background: rgba(255, 204, 0, 0.2); color: #ffcc00;}
    .risk-badge.aggressive {background: rgba(255, 59, 48, 0.2); color: #ff3b30;}
    
    .risk-heat-meter {margin-top: 8px;}
    .heat-bar {height: 6px; border-radius: 3px; background: linear-gradient(90deg, #4cd964 0%, #ffcc00 50%, #ff3b30 100%); position: relative; overflow: hidden;}
    .heat-bar::after {content: ''; position: absolute; top: -2px; bottom: -2px; width: 4px; background: #fff; border-radius: 2px; box-shadow: 0 0 8px rgba(255,255,255,0.8); transition: left 0.3s ease;}
    .heat-labels {display: flex; justify-content: space-between; margin-top: 4px; font-size: 10px; color: #aaa;}
    
    .tooltip {display: inline-block; width: 16px; height: 16px; background: rgba(78, 84, 200, 0.3); border-radius: 50%; text-align: center; line-height: 16px; font-size: 10px; cursor: help; color: #8f94fb;}
    
    .risk-summary-dashboard {background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-top: 20px;}
    .risk-summary-dashboard h3 {color: #fff; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;}
    .summary-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;}
    .summary-item {background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1);}
    .summary-label {font-size: 11px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;}
    .summary-value {font-size: 16px; font-weight: 700; color: #fff;}
    .summary-value.risk-amount {color: #ff3b30;}
    .summary-value.profit-amount {color: #4cd964;}
    .summary-value.rr-ratio {color: #8f94fb;}
    
    .form-control {width: 100%; padding: 0.625rem 0.75rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 0.375rem; background: rgba(0,0,0,0.2); color: #e6eef6; transition: border-color 0.3s ease;}
    .form-control:focus {outline: none; border-color: var(--accent);}
    .btn-success {background: linear-gradient(135deg, #4cd964, #2fb344); color: #fff;}
    .btn-info {background: linear-gradient(135deg, #17a2b8, #138496); color: #fff;}
    .hidden {display: none !important;}
    
    #unsavedIndicator {animation: pulse 2s infinite;}
    @keyframes pulse {0% {opacity: 0.7;} 50% {opacity: 1;} 100% {opacity: 0.7;}}
    
    /* Split Editor Styles */
    .split-preview-item { cursor: pointer; transition: all 0.2s ease; }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: #fff;
      font-weight: 600;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }
    .toast-success { background: rgba(76, 217, 100, 0.9); }
    .toast-error { background: rgba(255, 59, 48, 0.9); }
    .toast-info { background: rgba(78, 84, 200, 0.9); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Split Preview Table */
    .split-preview-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,0.05);
      border-radius: 0.5rem;
      overflow: hidden;
      margin-top: 0.75rem;
    }
    .split-preview-table th,
    .split-preview-table td {
      padding: 0.5rem 0.375rem;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 0.6875rem;
    }
    .split-preview-table th {
      background-color: rgba(255,255,255,0.1);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #e6eef6;
    }
    .split-preview-table td {
      color: var(--muted);
    }
    .split-action-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.625rem;
      border: 1px solid var(--accent);
      background: rgba(14,165,164,0.2);
      color: var(--accent);
      border-radius: 0.1875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .split-action-btn:hover {
      background: var(--accent);
      color: #041024;
    }
    .split-action-btn:focus {
      outline: 2px solid #8f94fb;
      outline-offset: 2px;
    }
    .inline-edit-input {
      width: 50px;
      padding: 2px 4px;
      font-size: 10px;
      border: 1px solid #4e54c8;
      border-radius: 2px;
      background: rgba(0,0,0,0.3);
      color: #fff;
    }
    .error-message {
      color: #ff3b30;
      font-size: 11px;
      margin-top: 5px;
      padding: 4px 8px;
      background: rgba(255,59,48,0.1);
      border-radius: 4px;
      border: 1px solid rgba(255,59,48,0.2);
    }
    
    @media (max-width: 768px) {
      .split-preview-table {
        font-size: 12px;
      }
      .split-preview-table th,
      .split-preview-table td {
        padding: 6px !important;
      }
    }
    .split-preview-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    
    /* Accessibility */
    .split-action-btn:focus {
      outline: 2px solid #8f94fb;
      outline-offset: 2px;
    }
    
    .form-control:focus {
      outline: 2px solid rgba(78, 84, 200, 0.5);
      outline-offset: 1px;
    }
    
    .toggle-btn {
      padding: 6px 12px;
      border: 1px solid #4e54c8;
      background: rgba(78,84,200,0.2);
      color: #8f94fb;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .toggle-btn:hover {
      background: rgba(78,84,200,0.4);
    }
    
    .toggle-btn.active {
      background: #4e54c8;
      color: white;
    }
    .editor-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; }
    .editor-panel { position: absolute; right: 0; top: 0; width: 400px; height: 100%; background: linear-gradient(135deg, #1a1a2e, #16213e); backdrop-filter: blur(10px); padding: 20px; overflow-y: auto; border-left: 2px solid #4e54c8; box-shadow: -5px 0 20px rgba(0,0,0,0.5); }
    .editor-header { border-bottom: 2px solid #4e54c8; padding-bottom: 15px; margin-bottom: 20px; }
    .field-group { margin-bottom: 20px; }
    .field-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #fff; font-size: 14px; }
    .field-group input { width: 100%; padding: 12px; border: 2px solid #4e54c8; border-radius: 6px; background: rgba(0,0,0,0.4); color: #fff; font-size: 14px; font-weight: 600; }
    .field-group input:read-only { background: rgba(78,84,200,0.2); border-color: #8f94fb; }
    .field-group input:focus { outline: none; border-color: #8f94fb; box-shadow: 0 0 10px rgba(143,148,251,0.3); }
    .toggle-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .toggle-btn { padding: 8px 16px; border: 2px solid #4e54c8; background: rgba(78,84,200,0.2); cursor: pointer; border-radius: 6px; color: #fff; font-weight: 600; transition: all 0.3s ease; }
    .toggle-btn:hover { background: rgba(78,84,200,0.4); transform: translateY(-1px); }
    .toggle-btn.active { background: #4e54c8; border-color: #8f94fb; box-shadow: 0 0 15px rgba(143,148,251,0.5); }
    .calc-display { font-size: 14px; color: #8f94fb; margin-top: 8px; font-weight: 600; }
    .error-msg { color: #ff3b30; font-size: 12px; margin-top: 5px; font-weight: 600; }
    .editor-actions { display: flex; gap: 15px; margin-top: 30px; }
    .editor-actions button { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, #4e54c8, #8f94fb); color: #fff; }
    .btn-primary:hover { background: linear-gradient(135deg, #3a3f99, #6f73d9); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(78,84,200,0.4); }
    .btn-secondary { background: linear-gradient(135deg, #6c757d, #495057); color: #fff; }
    .btn-secondary:hover { background: linear-gradient(135deg, #5a6268, #343a40); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108,117,125,0.4); }
</style>
{% endblock %}

{% block content %}
<div class="container max-w-7xl mx-auto">
  <header class="circuit-bg" style="position: relative;">
    <div class="stock-info">
      <div class="stock-icon"><i class="fas fa-brain"></i></div>
      <div class="stock-details">
        <h1 class="glow-text">{{ trade.derivative_name or trade.symbol or symbol }}</h1>
        <p>F&O: {{ trade.derivative_name or trade.symbol or symbol }} | Trade ID: {{ trade.id }}</p>
      </div>
    </div>
    <div class="live-price">
      <div class="price" id="livePrice">₹{{ "%.2f"|format(trade.ltp if trade.ltp else trade.avg_price) }}</div>
      <div class="change" id="liveChange">
        {{ "Buy Trade" if trade.trade_type|lower == "buy" else "Sell Trade" }}
      </div>
    </div>
    {% if trade.status == 'closed' %}
    <div style="position: absolute; top: 10px; right: 10px; background: rgba(255, 59, 48, 0.9); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 14px; z-index: 1000;">
      POSITION CLOSED
    </div>
    {% endif %}
  </header>

  <div class="dashboard">
    <!-- LEFT: Position Management -->
    <div class="card circuit-bg" id="positionManagementCard">
      <h2><i class="fas fa-chart-line"></i> F&O Position Management</h2>
      <div style="background: rgba(255, 204, 0, 0.1); border: 1px solid rgba(255, 204, 0, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #ffcc00; font-size: 14px;">
        <i class="fas fa-info-circle"></i> <strong>Update:</strong> Advanced F&O detail calculator with lot-based management and options analytics coming soon with enhanced features!
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="inpAvgPrice">Average Price (₹)</label>
          <input id="inpAvgPrice" type="number" step="0.01" value="{{ '%.2f'|format(trade.avg_price) }}">
        </div>
        <div class="form-group">
          <label for="inpQty">Quantity</label>
          <input id="inpQty" type="number" value="{{ trade.quantity }}">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="inpSL">Stop Loss (₹)</label>
          <input id="inpSL" type="number" step="0.01" value="{{ '%.2f'|format(trade.stop_loss_price) }}">
        </div>
        <div class="form-group">
          <label for="inpTarget">Target (₹)</label>
          <input id="inpTarget" type="number" step="0.01" value="{{ '%.2f'|format(trade.target_price) }}">
        </div>
      </div>

      <div class="actions" style="margin-bottom:16px;">
        <button id="updateBtn" class="btn-primary-large"><i class="fas fa-save"></i> Save Update</button>
        <button id="closeBtn" class="btn-sell-large"><i class="fas fa-times-circle"></i> Close Position</button>
      </div>

      <div class="stats tiles" id="summaryTiles">
        <div class="stat-item">
          <div class="stat-value" id="ts-capital">₹{{ '%.2f'|format(trade.capital_used) }}</div>
          <div class="stat-label">Capital Used</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ts-rr">1:{{ '%.1f'|format(trade.rr_ratio) }}</div>
          <div class="stat-label">Risk-Reward Ratio</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ts-profit">{{ '%.2f'|format(trade.expected_return) }}%</div>
          <div class="stat-label">Expected Return</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ts-risk">{{ '%.2f'|format(trade.risk_percent) }}%</div>
          <div class="stat-label">Risk Percentage</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: AI Trading Assistant -->
    <div class="card circuit-bg" id="modeCard">
      <h2><i class="fas fa-robot"></i> CNT Trading Assistant</h2>
      <div class="selector-row" style="margin-bottom:12px;">
        <select id="modeSelect" class="select">
          <option value="manual">Manual position management</option>
          <option value="ai" selected>CNT-powered position management</option>
        </select>
        <button id="backToManual" class="btn-back hidden">Back to Manual</button>
      </div>

      <div id="modeArea">
        <!-- MANUAL -->
        <div id="manualMode" class="hidden">
          <h4 style="color:#fff;margin-top:16px;">Manual Position Management</h4>
          <p style="color:#aaa;margin-bottom:16px;font-size:14px;">Split your position into multiple parts with different stop-loss and target levels for advanced risk management.</p>
          <div class="form-group" style="margin-bottom:12px;">
            <label for="splitMode">Split Mode</label>
            <select id="splitMode" class="select">
              <option value="full">Full Quantity</option>
              <option value="half">Divide in Half</option>
              <option value="custom">Custom Split</option>
            </select>
          </div>
          
          <div id="customSplitContainer" class="form-group hidden" style="margin-bottom:12px;">
            <label for="customSplitInput">Custom Split (comma-separated)</label>
            <input id="customSplitInput" type="text" placeholder="e.g., 10,6,6" class="form-control">
            <small style="color:#aaa;">Enter quantities separated by commas. Total must equal quantity.</small>
          </div>
          
          <!-- Applied Split Table -->
          <div id="appliedSplitTable" class="hidden" style="background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;margin-bottom:16px;">
            <h5 style="color:#fff;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;">
              Split Preview:
              <div style="display:flex;gap:8px;">
                <button id="saveTemplateBtn" class="tiny-link" style="font-size:12px;" onclick="savePreviewTemplate()">Save Preview Template</button>
                <button id="resetSplitBtn" class="tiny-link" style="font-size:12px;" onclick="resetSplitTable()">Reset</button>
                <button id="deleteTemplateBtn" class="tiny-link" style="font-size:12px;display:none;" onclick="deletePreviewTemplate()">Delete Template</button>
              </div>
            </h5>
            <table class="split-preview-table">
              <thead>
                <tr>
                  <th>PREVIEW</th>
                  <th>SL</th>
                  <th>TARGET</th>
                  <th>QTY</th>
                  <th>ACTION</th>
                </tr>
              </thead>
              <tbody id="splitTableBody">
              </tbody>
            </table>
          </div>
          
          <!-- Unsaved Changes Indicator -->
          <div id="unsavedIndicator" class="hidden" style="background:rgba(255,204,0,0.2);color:#ffcc00;padding:8px;border-radius:6px;margin-bottom:12px;font-size:14px;">
            <i class="fas fa-exclamation-triangle"></i> You have unsaved changes
          </div>


        </div>

        <!-- CNT MODE -->
        <div id="aiMode">

          
          <!-- CNT Rules Info -->
          <div id="cntRules" style="background:rgba(0,0,0,.2);padding:8px;border-radius:6px;margin-bottom:10px;font-size:10px;color:#aaa;">
            CNT Plan rules based on quantity:<br>
            <span id="smallRule">Small (1–3): SL = -2%, Exit-1 = +5% (100%)</span><br>
            <span id="mediumRule">Medium (4–10): SL = -2%, Exit-1 = +3% (30%), Exit-2 = +6% (70%)</span><br>
            <span id="largeRule">Large (>10): SL = -1.5%, Exit-1 = +2.5% (20%), Exit-2 = +5% (40%), Exit-3 = +7% (40%)</span>
          </div>
          
          <!-- CNT Actions -->
          <div style="display:flex;gap:6px;margin-bottom:10px;">
            <button class="btn-ai" style="flex:1;padding:8px 12px;font-size:12px;" onclick="generateCNTPlan()"><i class="fas fa-chart-line"></i> Generate CNT Plan</button>
            <button class="btn-ai" style="flex:1;padding:6px 8px;font-size:11px;" onclick="quickReset()">Reset</button>
          </div>
          
          <!-- CNT Plan Output -->
          <div id="plan" style="background:rgba(78,84,200,0.1);border-radius:6px;padding:8px;">
            <div style="font-size:11px;color:#8f94fb;margin-bottom:4px;">CNT Exit Strategy:</div>
            <div style="font-size:10px;color:#ddd;line-height:1.3;">
              Click <b>Generate CNT Plan</b> to create exit strategy
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced Interactive Risk Management Calculator -->
  <div class="card circuit-bg">
    <h2><i class="fas fa-calculator"></i> Advanced Risk Management Calculator</h2>
    
    <!-- Preset Risk Buttons -->
    <div class="risk-presets">
      <button class="preset-btn" data-risk="1">Safe (1%)</button>
      <button class="preset-btn" data-risk="2">Normal (2%)</button>
      <button class="preset-btn" data-risk="5">Aggressive (5%)</button>
    </div>
    
    <!-- Interactive Controls -->
    <div class="risk-controls">
      <!-- Account Capital -->
      <div class="control-group">
        <label>Account Capital (₹) <span class="tooltip" title="Total trading capital available">ⓘ</span></label>
        <div class="slider-input-combo">
          <input type="range" id="capital-slider" min="10000" max="1000000" step="10000" value="{{ trade.capital_used or 100000 }}">
          <input type="number" id="capital-input" min="10000" max="1000000" step="10000" value="{{ trade.capital_used or 100000 }}">
        </div>
      </div>
      
      <!-- Risk Percentage -->
      <div class="control-group">
        <label>Risk per Trade (%) <span class="risk-badge" id="risk-badge">Balanced</span></label>
        <div class="slider-input-combo">
          <input type="range" id="risk-slider" min="0.1" max="10" step="0.1" value="2">
          <input type="number" id="risk-input" min="0.1" max="10" step="0.1" value="2">
        </div>
        <!-- Risk Heat Meter -->
        <div class="risk-heat-meter">
          <div class="heat-bar" id="heat-bar"></div>
          <div class="heat-labels">
            <span>Conservative</span>
            <span>Balanced</span>
            <span>Aggressive</span>
          </div>
        </div>
      </div>
      
      <!-- Expected Return -->
      <div class="control-group">
        <label>Expected Return (%) <span class="tooltip" title="Target profit percentage">ⓘ</span></label>
        <div class="slider-input-combo">
          <input type="range" id="return-slider" min="1" max="20" step="0.5" value="5">
          <input type="number" id="return-input" min="1" max="20" step="0.5" value="5">
        </div>
      </div>
      
      <!-- Quantity -->
      <div class="control-group">
        <label>Quantity <span class="tooltip" title="Number of shares to trade">ⓘ</span></label>
        <div class="slider-input-combo">
          <input type="range" id="qty-slider" min="1" max="1000" step="1" value="{{ trade.quantity }}">
          <input type="number" id="qty-input" min="1" max="1000" step="1" value="{{ trade.quantity }}">
        </div>
      </div>
    </div>
    
    <!-- Live Summary Dashboard -->
    <div class="risk-summary-dashboard">
      <h3><i class="fas fa-chart-pie"></i> Live Position Summary</h3>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Position Value</div>
          <div class="summary-value" id="position-value">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Capital Used</div>
          <div class="summary-value" id="capital-used">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Risk Amount</div>
          <div class="summary-value risk-amount" id="risk-amount">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Expected Profit</div>
          <div class="summary-value profit-amount" id="expected-profit">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Risk:Reward Ratio</div>
          <div class="summary-value rr-ratio" id="rr-ratio">1:0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Target Price</div>
          <div class="summary-value" id="target-price">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Stop Loss</div>
          <div class="summary-value" id="stop-loss-price">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Breakeven</div>
          <div class="summary-value" id="breakeven-price">₹{{ '%.2f'|format(trade.avg_price) }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center;">
  <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 24px; max-width: 400px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
    <h3 style="color: #fff; margin-bottom: 16px; text-align: center;">Confirm Update</h3>
    <p style="color: #ddd; margin-bottom: 20px; text-align: center;">This will update your position, remove old calculations, and replace them with the new values. Do you want to continue?</p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="confirmYes" style="background: linear-gradient(135deg, #4e54c8, #8f94fb); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Yes, Update</button>
      <button id="confirmNo" style="background: linear-gradient(135deg, #ff416c, #ff4b2b); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Cancel</button>
    </div>
  </div>
</div>



<!-- Split Editor Overlay -->
<div class="editor-overlay" id="splitEditorOverlay">
  <div class="editor-panel">
    <div class="editor-header">
      <h3 style="color: #fff; margin-bottom: 8px;">Edit Split Position</h3>
      <p style="color: #aaa;">Part <span id="editPart"></span> — <span id="editQty"></span> shares</p>
    </div>
    
    <div class="field-group">
      <label>Average Price (₹)</label>
      <input type="number" id="editAvgPrice" readonly>
    </div>
    
    <div class="field-group">
      <label>Quantity</label>
      <input type="number" id="editQuantity" readonly>
    </div>
    
    <div class="field-group">
      <label>Stop-Loss</label>
      <div class="toggle-group">
        <button class="toggle-btn active" id="stopPctBtn">%</button>
        <button class="toggle-btn" id="stopPriceBtn">₹</button>
      </div>
      <input type="number" id="stopInput" placeholder="Enter stop loss %">
      <div class="calc-display" id="stopCalc"></div>
      <div class="error-msg" id="stopError"></div>
    </div>
    
    <div class="field-group">
      <label>Target</label>
      <div class="toggle-group">
        <button class="toggle-btn active" id="targetPctBtn">%</button>
        <button class="toggle-btn" id="targetPriceBtn">₹</button>
      </div>
      <input type="number" id="targetInput" placeholder="Enter target %">
      <div class="calc-display" id="targetCalc"></div>
      <div class="error-msg" id="targetError"></div>
    </div>
    
    <div class="editor-actions">
      <button class="btn btn-primary" id="splitApplyBtn">Apply</button>
      <button class="btn btn-secondary" id="splitCancelBtn">Cancel</button>
    </div>
  </div>
</div>



{% endblock %}

{% block extra_js %}
<script>
/* ---------- Trade data from backend ---------- */
const tradeData = {
  id: "{{ trade.id }}",
  tradeType: "{{ trade.trade_type|lower }}",
  avgPrice: parseFloat("{{ '%.2f'|format(trade.avg_price) }}"),
  stopLoss: parseFloat("{{ '%.2f'|format(trade.stop_loss_price) }}"),
  quantity: parseInt("{{ trade.quantity }}"),
  target: parseFloat("{{ '%.2f'|format(trade.target_price) }}"),
  ltp: parseFloat("{{ '%.2f'|format(trade.ltp if trade.ltp else trade.avg_price) }}"),
  capital_used: parseFloat("{{ '%.2f'|format(trade.capital_used) }}"),
  rr_ratio: parseFloat("{{ '%.1f'|format(trade.rr_ratio) }}"),
  expected_return: parseFloat("{{ '%.2f'|format(trade.expected_return) }}"),
  risk_percent: parseFloat("{{ '%.2f'|format(trade.risk_percent) }}"),
  total_reward: parseFloat("{{ '%.2f'|format(trade.total_reward) }}"),
  total_risk: parseFloat("{{ '%.2f'|format(trade.total_risk) }}"),
  symbol: "{{ trade.symbol }}",
  commentSymbol: "{{ trade.comment }}",
  status: "{{ trade.status or 'open' }}",
  timestamp: new Date("{{ trade.timestamp }}")
};

// Swing specific: No leverage calculation (capital = avg_price * quantity)
const leverageMultiplier = 1; // Swing uses no leverage

document.getElementById('liveChange').className = 'change ' + 
  (parseFloat("{{ trade.change_percent if trade.change_percent else 0 }}") >= 0 ? 'positive' : 'negative');

let avgPriceValue = tradeData.avgPrice;
let totalQuantity = tradeData.quantity;
let parts = [];
let globalPartId = 1;
let pivotEnabled = false;
let simulationInterval = null;
let aiPlanData = null;




// CNT Rules Storage
let cntRules = {
  small: { sl: -2, exit1: 5, exit1Pct: 100 },
  medium: { sl: -2, exit1: 3, exit1Pct: 30, exit2: 6, exit2Pct: 70 },
  large: { sl: -1.5, exit1: 2.5, exit1Pct: 20, exit2: 5, exit2Pct: 40, exit3: 7, exit3Pct: 40 }
};

// CNT rules are fixed - no need to load/save
function loadCNTRules() {
  // Rules are fixed, no loading needed
}

function saveCNTRulesToStorage() {
  // Rules are fixed, no saving needed
}

// Rules are now fixed and displayed as text - no updates needed
function updateRulesDisplay() {
  // Rules are fixed in HTML, no dynamic updates needed
}



// CNT Plan Generator
function generateCNTPlan() {
  const entry = tradeData.avgPrice;
  const qty = tradeData.quantity;
  const planDiv = document.getElementById('plan');
  const statusEl = document.getElementById('aiStatus');
  const timeEl = document.getElementById('processingTime');
  
  generateCNTTable();
  
  function generateCNTTable() {
    let tableHTML = '';
    let ruleType = '';
    
    if (qty <= 3) {
      ruleType = 'Small Position Strategy';
      const slPrice = (entry * (1 + cntRules.small.sl/100)).toFixed(2);
      const targetPrice = (entry * (1 + cntRules.small.exit1/100)).toFixed(2);
      const targetQty = qty;
      
      tableHTML = `
        <table style="width:100%;border-collapse:collapse;margin-top:8px;">
          <thead>
            <tr style="background:rgba(255,255,255,0.1);">
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Exit</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Trigger</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Price</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Qty</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">%</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">Exit-1</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">+${cntRules.small.exit1}%</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">₹${targetPrice}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${targetQty}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">100%</td>
            </tr>
            <tr>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#ff3b30;">Stop Loss</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${cntRules.small.sl}%</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#ff3b30;">₹${slPrice}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${qty}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">100%</td>
            </tr>
          </tbody>
        </table>
      `;
    } else if (qty <= 10) {
      ruleType = 'Medium Position Strategy';
      const slPrice = (entry * 0.98).toFixed(2);
      const exit1Price = (entry * 1.03).toFixed(2);
      const exit2Price = (entry * 1.06).toFixed(2);
      const exit1Qty = Math.floor(qty * 0.3);
      const exit2Qty = qty - exit1Qty;
      
      tableHTML = `
        <table style="width:100%;border-collapse:collapse;margin-top:8px;">
          <thead>
            <tr style="background:rgba(255,255,255,0.1);">
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Exit</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Trigger</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Price</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Qty</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">%</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">Exit-1</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">+3%</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">₹${exit1Price}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${exit1Qty}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">30%</td>
            </tr>
            <tr>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">Exit-2</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">+6%</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">₹${exit2Price}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${exit2Qty}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">70%</td>
            </tr>
            <tr>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#ff3b30;">Stop Loss</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">-2%</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#ff3b30;">₹${slPrice}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${qty}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">100%</td>
            </tr>
          </tbody>
        </table>
      `;
    } else {
      ruleType = 'Large Position Strategy';
      const slPrice = (entry * 0.985).toFixed(2);
      const exit1Price = (entry * 1.025).toFixed(2);
      const exit2Price = (entry * 1.05).toFixed(2);
      const exit3Price = (entry * 1.07).toFixed(2);
      const exit1Qty = Math.floor(qty * 0.2);
      const exit2Qty = Math.floor(qty * 0.4);
      const exit3Qty = qty - exit1Qty - exit2Qty;
      
      tableHTML = `
        <table style="width:100%;border-collapse:collapse;margin-top:8px;">
          <thead>
            <tr style="background:rgba(255,255,255,0.1);">
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Exit</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Trigger</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Price</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">Qty</th>
              <th style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">%</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">Exit-1</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">+2.5%</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">₹${exit1Price}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${exit1Qty}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">20%</td>
            </tr>
            <tr>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">Exit-2</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">+5%</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">₹${exit2Price}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${exit2Qty}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">40%</td>
            </tr>
            <tr>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">Exit-3</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">+7%</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#4cd964;">₹${exit3Price}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${exit3Qty}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">40%</td>
            </tr>
            <tr>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#ff3b30;">Stop Loss</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">-1.5%</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);color:#ff3b30;">₹${slPrice}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">${qty}</td>
              <td style="padding:6px;font-size:10px;border:1px solid rgba(255,255,255,0.1);">100%</td>
            </tr>
          </tbody>
        </table>
      `;
    }
    
    planDiv.innerHTML = `
      <div style="font-size:11px;color:#8f94fb;margin-bottom:4px;">CNT Strategy: ${ruleType}</div>
      ${tableHTML}
    `;
    
    showToast('CNT exit strategy generated!', 'success');
  }
}

function quickReset() {
  document.getElementById('plan').innerHTML = `
    <div style="font-size:11px;color:#8f94fb;margin-bottom:4px;">CNT Exit Strategy:</div>
    <div style="font-size:10px;color:#ddd;line-height:1.3;">
      Click <b>Generate CNT Plan</b> to create exit strategy
    </div>
  `;

  showToast('CNT plan reset', 'info');
}

// AI Button handlers
function setupAIButtons() {
  document.getElementById('btnPlan')?.addEventListener('click', generateCNTPlan);
}

/* ---------- Export to Journal Function ---------- */
function exportCurrentTradeToJournal() {
  const tradeData = {
    symbol: document.querySelector('.stock-details h1').textContent,
    entry_price: parseFloat(document.getElementById('inpAvgPrice').value),
    quantity: parseInt(document.getElementById('inpQty').value),
    stop_loss: parseFloat(document.getElementById('inpSL').value),
    target: parseFloat(document.getElementById('inpTarget').value),
    trade_type: 'swing',
    strategy: 'Swing Trading',
    notes: `Exported from Swing Calculator - Trade ID: ${tradeData.id}`
  };
  
  fetch('/api/export-to-journal', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(tradeData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('Trade exported to journal successfully!', 'success');
    } else {
      showToast('Failed to export trade: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Export error:', error);
    showToast('Export failed. Please try again.', 'error');
  });
}

/* ---------- Mode switch ---------- */
const modeSelect = document.getElementById('modeSelect');
const backToManualBtn = document.getElementById('backToManual');
const modeCard = document.getElementById('modeCard');
const positionCard = document.getElementById('positionManagementCard');

/* ---------- Manual Split Management ---------- */
const splitModeSelect = document.getElementById('splitMode');
const customSplitContainer = document.getElementById('customSplitContainer');
const appliedSplitTable = document.getElementById('appliedSplitTable');

// Initialize split management on page load
if (splitModeSelect && customSplitContainer && appliedSplitTable) {
  // Setup is handled in the init function
}

modeSelect.addEventListener('change', ()=>{
  const val = modeSelect.value;
  const isAIMode = val === 'ai';
  
  document.getElementById('manualMode').classList.toggle('hidden', isAIMode);
  document.getElementById('aiMode').classList.toggle('hidden', !isAIMode);
  backToManualBtn.classList.toggle('hidden', !isAIMode);
});

if (splitModeSelect) {
  splitModeSelect.addEventListener('change', () => {
    const value = splitModeSelect.value;
    if (customSplitContainer) {
      customSplitContainer.classList.toggle('hidden', value !== 'custom');
    }
    
    if (value !== 'custom') {
      generateSplitPreview(value);
    }
  });
}

function generateSplitPreview(mode) {
  const qty = parseInt(document.getElementById('inpQty').value) || 0;
  const avgPrice = parseFloat(document.getElementById('inpAvgPrice').value) || 0;
  const sl = parseFloat(document.getElementById('inpSL').value) || 0;
  const target = parseFloat(document.getElementById('inpTarget').value) || 0;
  
  if (qty <= 0 || avgPrice <= 0) {
    showToast('Please enter valid quantity and average price', 'error');
    return;
  }
  
  parts = [];
  
  if (mode === 'full') {
    parts.push({ id: 1, quantity: qty, stopLoss: sl, target: target });
  } else if (mode === 'half') {
    const half = Math.floor(qty / 2);
    const remainder = qty - half;
    parts.push({ id: 1, quantity: half, stopLoss: sl, target: target });
    parts.push({ id: 2, quantity: remainder, stopLoss: sl, target: target });
  }
  
  updateSplitTable();
}

function updateSplitTable() {
  const tbody = document.getElementById('splitTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  parts.forEach((part, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>Part ${part.id}</td>
      <td>₹${part.stopLoss.toFixed(2)}</td>
      <td>₹${part.target.toFixed(2)}</td>
      <td>${part.quantity}</td>
      <td><button class="split-action-btn" onclick="editSplitPart(${index})">Edit</button></td>
    `;
    tbody.appendChild(row);
  });
  
  appliedSplitTable.classList.remove('hidden');
  const indicator = document.getElementById('unsavedIndicator');
  if (indicator) indicator.classList.remove('hidden');
}

function editSplitPart(index) {
  if (parts[index]) {
    const part = parts[index];
    const newSL = prompt(`Edit Stop Loss for Part ${part.id} (current: ₹${part.stopLoss.toFixed(2)}):`, part.stopLoss);
    const newTarget = prompt(`Edit Target for Part ${part.id} (current: ₹${part.target.toFixed(2)}):`, part.target);
    
    if (newSL && !isNaN(newSL)) {
      parts[index].stopLoss = parseFloat(newSL);
    }
    if (newTarget && !isNaN(newTarget)) {
      parts[index].target = parseFloat(newTarget);
    }
    
    updateSplitTable();
    showToast('Split part updated!', 'success');
  }
}

backToManualBtn.addEventListener('click', () => {
  modeSelect.value = 'manual';
  modeSelect.dispatchEvent(new Event('change'));
});

// Load saved template on page load
document.addEventListener('DOMContentLoaded', () => {
  const savedTemplate = localStorage.getItem('swingSplitTemplate');
  if (savedTemplate) {
    document.getElementById('deleteTemplateBtn').style.display = 'inline-block';
  }
});

/* ---------- Real-time input updates ---------- */
function setupInputListeners() {
  const inputs = ['inpAvgPrice', 'inpQty', 'inpSL', 'inpTarget'];
  inputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', () => {
        updateLiveCalculations();
        updateRiskCalculations();
        saveInputsToStorage();
      });
    }
  });
}

function saveInputsToStorage() {
  const inputData = {
    avgPrice: document.getElementById('inpAvgPrice').value,
    quantity: document.getElementById('inpQty').value,
    stopLoss: document.getElementById('inpSL').value,
    target: document.getElementById('inpTarget').value,
    tradeId: tradeData.id
  };
  localStorage.setItem(`swing_trade_${tradeData.id}`, JSON.stringify(inputData));
}

function loadInputsFromStorage() {
  const saved = localStorage.getItem(`swing_trade_${tradeData.id}`);
  if (saved) {
    try {
      const data = JSON.parse(saved);
      if (data.avgPrice) document.getElementById('inpAvgPrice').value = data.avgPrice;
      if (data.quantity) document.getElementById('inpQty').value = data.quantity;
      if (data.stopLoss) document.getElementById('inpSL').value = data.stopLoss;
      if (data.target) document.getElementById('inpTarget').value = data.target;
      updateLiveCalculations();
    } catch (e) {
      console.error('Error loading saved inputs:', e);
    }
  }
}

function updateLiveCalculations() {
  const avgPrice = parseFloat(document.getElementById('inpAvgPrice').value) || 0;
  const quantity = parseInt(document.getElementById('inpQty').value) || 0;
  const stopLoss = parseFloat(document.getElementById('inpSL').value) || 0;
  const target = parseFloat(document.getElementById('inpTarget').value) || 0;
  
  if (avgPrice > 0 && quantity > 0) {
    const capitalUsed = avgPrice * quantity;
    const riskAmount = Math.abs(avgPrice - stopLoss) * quantity;
    const rewardAmount = Math.abs(target - avgPrice) * quantity;
    const rrRatio = rewardAmount / riskAmount;
    const riskPercent = (riskAmount / capitalUsed) * 100;
    const expectedReturn = (rewardAmount / capitalUsed) * 100;
    
    document.getElementById('ts-capital').textContent = `₹${capitalUsed.toFixed(2)}`;
    document.getElementById('ts-rr').textContent = `1:${rrRatio.toFixed(1)}`;
    document.getElementById('ts-profit').textContent = `${expectedReturn.toFixed(2)}%`;
    document.getElementById('ts-risk').textContent = `${riskPercent.toFixed(2)}%`;
  }
}

/* ---------- Update/Close buttons ---------- */
document.getElementById('updateBtn').addEventListener('click', showConfirmModal);
document.getElementById('closeBtn').addEventListener('click', ()=>{
  if (confirm('Are you sure you want to close this position?')) {
    closePosition();
  }
});

function showConfirmModal() {
  document.getElementById('confirmModal').style.display = 'flex';
}

document.getElementById('confirmYes').addEventListener('click', () => {
  document.getElementById('confirmModal').style.display = 'none';
  savePositionUpdate();
});
document.getElementById('confirmNo').addEventListener('click', () => {
  document.getElementById('confirmModal').style.display = 'none';
});

async function savePositionUpdate() {
  const avgPrice = parseFloat(document.getElementById('inpAvgPrice').value);
  const quantity = parseInt(document.getElementById('inpQty').value);
  const stopLoss = parseFloat(document.getElementById('inpSL').value);
  const target = parseFloat(document.getElementById('inpTarget').value);
  
  const updateData = {
    trade_id: tradeData.id,
    avg_price: avgPrice,
    quantity: quantity,
    stop_loss_price: stopLoss,
    target_price: target
  };
  
  try {
    const response = await fetch('/save_swing_update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      updatePositionUI(result.trade);
      localStorage.removeItem(`swing_trade_${tradeData.id}`);
      showToast('Position updated successfully!', 'success');
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
}

async function closePosition() {
  try {
    const response = await fetch('/close_swing_position', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trade_id: tradeData.id })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('POSITION CLOSED', 'success');
      tradeData.status = 'closed';
      
      const closeBtn = document.getElementById('closeBtn');
      closeBtn.textContent = 'Reopen Position';
      closeBtn.className = 'btn-ai';
      closeBtn.onclick = () => {
        if (confirm('Are you sure you want to reopen this position?')) {
          reopenPosition();
        }
      };
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
}

async function reopenPosition() {
  try {
    const response = await fetch('/reopen_swing_position', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trade_id: tradeData.id })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('POSITION REOPENED', 'success');
      tradeData.status = 'open';
      
      const closeBtn = document.getElementById('closeBtn');
      closeBtn.textContent = 'Close Position';
      closeBtn.className = 'btn-sell';
      closeBtn.onclick = () => {
        if (confirm('Are you sure you want to close this position?')) {
          closePosition();
        }
      };
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 3000);
}

function updatePositionUI(trade) {
  document.getElementById('ts-capital').textContent = `₹${trade.capital_used.toLocaleString()}`;
  document.getElementById('ts-rr').textContent = `1:${trade.rr_ratio}`;
  document.getElementById('ts-profit').textContent = `${trade.expected_return}%`;
  document.getElementById('ts-risk').textContent = `${trade.risk_percent}%`;
  
  document.getElementById('inpAvgPrice').value = trade.avg_price;
  document.getElementById('inpQty').value = trade.quantity;
  document.getElementById('inpSL').value = trade.stop_loss_price;
  document.getElementById('inpTarget').value = trade.target_price;
  
  Object.assign(tradeData, trade);
}

/* ================== AI EXIT PLANNER ENGINE ================== */
const $ = (id)=>document.getElementById(id);
const log = (msg)=>{ 
  const t = new Date().toLocaleTimeString(); 
  const ailog = document.getElementById('ailog');
  if (ailog) {
    ailog.insertAdjacentHTML('beforeend', `<div><span style="color:#6ea9ff">[${t}]</span> ${msg}</div>`); 
    ailog.scrollTop = ailog.scrollHeight;
  }
}
const format = (n, d=2)=> Number(n).toFixed(d);

function leveragedMove(entry, pct){ return (entry/leverageMultiplier) * (pct/100); }
function priceFromPct(entry, pct, side){
  return side === 'buy' ? entry + leveragedMove(entry, pct)
                        : entry - leveragedMove(entry, pct);
}

function getRuleSet(qty) {
  if (qty <= 3) {
    return {
      name: 'Small',
      slPercent: 2.0,
      exits: [{ percent: 5.0, allocation: 100 }]
    };
  } else if (qty <= 10) {
    return {
      name: 'Medium',
      slPercent: 2.0,
      exits: [{ percent: 3.0, allocation: 30 }, { percent: 6.0, allocation: 70 }]
    };
  } else {
    return {
      name: 'Large',
      slPercent: 1.5,
      exits: [{ percent: 2.5, allocation: 20 }, { percent: 5.0, allocation: 40 }, { percent: 7.0, allocation: 40 }]
    };
  }
}

function getEntryAndQty(){
  const e = parseFloat(document.getElementById('inpAvgPrice').value);
  const q = parseInt(document.getElementById('inpQty').value,10);
  return {entry:e, qty:q};
}

async function makePlan(){
  const {entry, qty} = getEntryAndQty();
  
  if(!(entry>0 && qty>0)){
    alert('Please enter a valid Average Price and Quantity in the Position Management section.');
    return;
  }

  const ailog = document.getElementById('ailog');
  const plan = document.getElementById('plan');
  if (ailog) ailog.innerHTML = '';
  if (plan) plan.innerHTML = '<div style="text-align:center;padding:20px;color:#8f94fb;"><i class="fas fa-brain" style="animation:brain-pulse 1.5s infinite;"></i><br>AI is analyzing your entry, quantity, and volatility bands...</div>';
  
  log('AI is analyzing your entry, quantity, and volatility bands...');
  await new Promise(resolve => setTimeout(resolve, 1200));
  
  const planElement = document.getElementById('plan');
  if (planElement) planElement.innerHTML = '<div style="text-align:center;padding:20px;color:#8f94fb;"><i class="fas fa-brain" style="animation:brain-pulse 1.5s infinite;"></i><br>AI is preparing your personalized exit strategy...</div>';
  log('AI is preparing your personalized exit strategy...');
  await new Promise(resolve => setTimeout(resolve, 1300));
  
  log('Parsing inputs…');
  setTimeout(()=>log(`Entry ₹${format(entry)} | Quantity ${qty}`), 200);
  
  const ruleSet = getRuleSet(qty);
  setTimeout(()=>log(`Applied ${ruleSet.name} rule set`), 400);

  const side = (tradeData.tradeType==='buy') ? 'buy' : 'sell';
  const trigSign = side==='buy' ? '+' : '-';
  const slSign   = side==='buy' ? '-' : '+';
  
  const slPrice = side==='buy'
    ? entry - leveragedMove(entry, ruleSet.slPercent)
    : entry + leveragedMove(entry, ruleSet.slPercent);
  
  let remainingQty = qty;
  const exits = [];
  
  for (let i = 0; i < ruleSet.exits.length; i++) {
    const exit = ruleSet.exits[i];
    const exitQty = Math.floor(qty * (exit.allocation / 100));
    const exitPrice = priceFromPct(entry, exit.percent, side);
    
    exits.push({
      index: i+1,
      percent: exit.percent,
      qty: exitQty,
      price: exitPrice,
      allocation: exit.allocation
    });
    
    remainingQty -= exitQty;
  }
  
  if (remainingQty > 0 && exits.length > 0) {
    exits[exits.length-1].qty += remainingQty;
  }
  
  aiPlanData = {ruleSet, entry, qty, slPrice, slPercent: ruleSet.slPercent, exits, side, trigSign, slSign};

  let planHTML = `
    <table aria-label="Exit Plan">
      <thead>
        <tr>
          <th>Leg</th>
          <th>Trigger</th>
          <th>Qty</th>
          <th>Exit Price</th>
          <th>Value</th>
          <th>Intent</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  exits.forEach((exit, index) => {
    planHTML += `
        <tr>
          <td>Exit-${exit.index}</td>
          <td>${trigSign}${format(exit.percent,1)}%</td>
          <td>${exit.qty} (${exit.allocation}%)</td>
          <td>₹${format(exit.price)}</td>
          <td>₹${format(exit.price * exit.qty)}</td>
          <td><span class="pill ${index === 0 ? 'warn' : 'good'}">${index === 0 ? 'Recover Cost' : 'Lock Profit'}</span></td>
        </tr>
    `;
  });
  
  planHTML += `
        <tr>
          <td>Stop Loss</td>
          <td>${slSign}${format(ruleSet.slPercent,1)}%</td>
          <td>${qty}</td>
          <td>₹${format(slPrice)}</td>
          <td>₹${format(slPrice * qty)}</td>
          <td><span class="pill" style="background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)">Risk Management</span></td>
        </tr>
      </tbody>
    </table>
    <div class="actions" style="margin-top:8px;gap:8px;justify-content:flex-start">
      <button class="tiny-link" id="copyPlan">Copy Plan</button>
      <button class="tiny-link" id="copyLevels">Copy Levels Only</button>
    </div>
  `;

  setTimeout(() => {
    const plan = document.getElementById('plan');
    if (plan) plan.innerHTML = planHTML;
    log('AI exit strategy generated successfully!');
  }, 300);

  setTimeout(()=>log(`Stop Loss set @ ₹${format(slPrice)} (${slSign}${ruleSet.slPercent}%)`), 600);
  
  exits.forEach((exit, index) => {
    setTimeout(()=>log(`Exit-${exit.index} set @ ₹${format(exit.price)} (${trigSign}${exit.percent}%) for ${exit.qty} qty (${exit.allocation}%)`), 800 + index * 200);
  });
}

document.getElementById('btnPlan')?.addEventListener('click', generateCNTPlan);
document.getElementById('btnReset')?.addEventListener('click', ()=>{
  const ailog = document.getElementById('ailog');
  if (ailog) ailog.innerHTML = '';
  const plan = document.getElementById('plan');
  if (plan) plan.innerHTML = '<p style="color:#aaa">Click <b>Generate CNT Plan</b>. The exits will appear here based on quantity.</p>';
  aiPlanData = null;
});

/* ================== SWING SPLIT EDITOR ================== */
let splitCurrentEdit = null;
let splitStopMode = 'pct';
let splitTargetMode = 'pct';

window.editSplitPart = function(partNumber, qty) {
  const overlay = document.getElementById('splitEditorOverlay');
  splitCurrentEdit = { part: partNumber, qty: qty };
  
  document.getElementById('editPart').textContent = partNumber;
  document.getElementById('editQty').textContent = qty;
  document.getElementById('editAvgPrice').value = document.getElementById('inpAvgPrice').value;
  document.getElementById('editQuantity').value = qty;
  
  document.getElementById('stopInput').value = '';
  document.getElementById('targetInput').value = '';
  setSplitToggleMode('stop', 'pct');
  setSplitToggleMode('target', 'pct');
  
  overlay.style.display = 'block';
  updateSplitCalculations();
};

function setSplitToggleMode(type, mode) {
  const input = document.getElementById(type === 'stop' ? 'stopInput' : 'targetInput');
  if (type === 'stop') {
    splitStopMode = mode;
    document.getElementById('stopPctBtn').classList.toggle('active', mode === 'pct');
    document.getElementById('stopPriceBtn').classList.toggle('active', mode === 'price');
    input.placeholder = mode === 'pct' ? 'Enter stop loss %' : 'Enter stop loss price';
  } else {
    splitTargetMode = mode;
    document.getElementById('targetPctBtn').classList.toggle('active', mode === 'pct');
    document.getElementById('targetPriceBtn').classList.toggle('active', mode === 'price');
    input.placeholder = mode === 'pct' ? 'Enter target %' : 'Enter target price';
  }
  input.value = '';
  updateSplitCalculations();
}

function calcStopPrice(avg, pct) { return avg * (1 - pct / 100); }
function calcTargetPrice(avg, pct) { return avg * (1 + pct / 100); }
function calcStopPct(avg, price) { return (1 - price / avg) * 100; }
function calcTargetPct(avg, price) { return (price / avg - 1) * 100; }
function isValidNumber(val) { return !isNaN(val) && isFinite(val) && val > 0; }

function updateSplitCalculations() {
  const avg = parseFloat(document.getElementById('inpAvgPrice').value);
  const applyBtn = document.getElementById('splitApplyBtn');
  const stopCalc = document.getElementById('stopCalc');
  const targetCalc = document.getElementById('targetCalc');
  const stopError = document.getElementById('stopError');
  const targetError = document.getElementById('targetError');
  const stopInput = document.getElementById('stopInput');
  const targetInput = document.getElementById('targetInput');
  
  if (!isValidNumber(avg)) {
    applyBtn.disabled = true;
    stopCalc.textContent = 'Average Price unavailable';
    targetCalc.textContent = 'Average Price unavailable';
    return;
  }
  applyBtn.disabled = false;
  
  const stopVal = parseFloat(stopInput.value);
  if (isValidNumber(stopVal)) {
    stopError.textContent = '';
    if (splitStopMode === 'pct') {
      const price = calcStopPrice(avg, stopVal);
      stopCalc.textContent = `Stop Price: ₹${price.toFixed(2)}`;
    } else {
      const pct = calcStopPct(avg, stopVal);
      stopCalc.textContent = `Stop %: ${pct.toFixed(2)}%`;
    }
  } else {
    stopCalc.textContent = '';
    if (stopInput.value) stopError.textContent = 'Invalid stop loss value';
  }
  
  const targetVal = parseFloat(targetInput.value);
  if (isValidNumber(targetVal)) {
    targetError.textContent = '';
    if (splitTargetMode === 'pct') {
      const price = calcTargetPrice(avg, targetVal);
      targetCalc.textContent = `Target Price: ₹${price.toFixed(2)}`;
    } else {
      const pct = calcTargetPct(avg, targetVal);
      targetCalc.textContent = `Target %: ${pct.toFixed(2)}%`;
    }
  } else {
    targetCalc.textContent = '';
    if (targetInput.value) targetError.textContent = 'Invalid target value';
  }
}

function initSplitEditor() {
  const overlay = document.getElementById('splitEditorOverlay');
  
  document.getElementById('inpAvgPrice').addEventListener('input', () => {
    const editAvgPrice = document.getElementById('editAvgPrice');
    if (editAvgPrice) editAvgPrice.value = document.getElementById('inpAvgPrice').value;
    updateSplitCalculations();
  });
  
  document.getElementById('stopInput')?.addEventListener('input', updateSplitCalculations);
  document.getElementById('targetInput')?.addEventListener('input', updateSplitCalculations);
  
  document.getElementById('stopPctBtn')?.addEventListener('click', () => setSplitToggleMode('stop', 'pct'));
  document.getElementById('stopPriceBtn')?.addEventListener('click', () => setSplitToggleMode('stop', 'price'));
  document.getElementById('targetPctBtn')?.addEventListener('click', () => setSplitToggleMode('target', 'pct'));
  document.getElementById('targetPriceBtn')?.addEventListener('click', () => setSplitToggleMode('target', 'price'));
  
  document.getElementById('splitApplyBtn')?.addEventListener('click', () => {
    if (!splitCurrentEdit) return;
    const avg = parseFloat(document.getElementById('inpAvgPrice').value);
    const stopVal = parseFloat(document.getElementById('stopInput').value);
    const targetVal = parseFloat(document.getElementById('targetInput').value);
    
    let stopPrice = null, targetPrice = null;
    if (isValidNumber(stopVal)) {
      stopPrice = splitStopMode === 'pct' ? calcStopPrice(avg, stopVal) : stopVal;
    }
    if (isValidNumber(targetVal)) {
      targetPrice = splitTargetMode === 'pct' ? calcTargetPrice(avg, targetVal) : targetVal;
    }
    
    const tableBody = document.getElementById('splitTableBody');
    const rows = tableBody.querySelectorAll('tr');
    const rowIndex = splitCurrentEdit.part - 1;
    
    if (rows[rowIndex]) {
      const cells = rows[rowIndex].querySelectorAll('td');
      if (cells.length >= 4) {
        cells[1].textContent = stopPrice ? `₹${stopPrice.toFixed(2)}` : '₹0.00';
        cells[2].textContent = targetPrice ? `₹${targetPrice.toFixed(2)}` : '₹0.00';
      }
    }
    
    showToast('Swing split values updated successfully!', 'success');
    overlay.style.display = 'none';
    markUnsavedChanges();
  });
  
  document.getElementById('splitCancelBtn')?.addEventListener('click', () => {
    overlay.style.display = 'none';
  });
  
  overlay?.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.style.display = 'none';
  });
}

function markUnsavedChanges() {
  const indicator = document.getElementById('unsavedIndicator');
  if (indicator) indicator.classList.remove('hidden');
}

function clearUnsavedChanges() {
  const indicator = document.getElementById('unsavedIndicator');
  if (indicator) indicator.classList.add('hidden');
}

window.savePreviewTemplate = async function() {
  const splitTableBody = document.getElementById('splitTableBody');
  if (!splitTableBody || splitTableBody.children.length === 0) {
    showToast('No split data to save', 'error');
    return;
  }
  
  const templateData = {
    splitMode: currentSplitMode,
    splitParts: splitParts,
    tableData: Array.from(splitTableBody.children).map(row => {
      const cells = row.querySelectorAll('td');
      return {
        preview: cells[0]?.textContent || '',
        sl: cells[1]?.textContent || '',
        target: cells[2]?.textContent || '',
        qty: cells[3]?.textContent || ''
      };
    }),
    timestamp: Date.now()
  };
  
  localStorage.setItem('swingSplitTemplate', JSON.stringify(templateData));
  showToast('Template saved successfully!', 'success');
  toggleButtons(true);
};

window.deletePreviewTemplate = async function() {
  localStorage.removeItem('swingSplitTemplate');
  showToast('Template deleted successfully!', 'success');
  toggleButtons(false);
};

window.resetSplitTable = function() {
  const splitTableBody = document.getElementById('splitTableBody');
  const appliedSplitTable = document.getElementById('appliedSplitTable');
  
  if (splitTableBody) {
    splitTableBody.innerHTML = '';
  }
  if (appliedSplitTable) {
    appliedSplitTable.classList.add('hidden');
  }
  
  // Reset split parts
  splitParts = [];
  currentSplitMode = 'full';
  document.getElementById('splitMode').value = 'full';
  
  showToast('Split table reset successfully!', 'info');
};

function toggleButtons(saved) {
  const resetBtn = document.getElementById('resetSplitBtn');
  const deleteBtn = document.getElementById('deleteTemplateBtn');
  if (resetBtn) resetBtn.style.display = saved ? 'none' : 'inline-block';
  if (deleteBtn) deleteBtn.style.display = saved ? 'inline-block' : 'none';
}

// Load templates on page load
async function loadTemplates() {
  const saved = localStorage.getItem('swingSplitTemplate');
  if (saved) {
    try {
      const templateData = JSON.parse(saved);
      
      // Restore split mode
      if (templateData.splitMode) {
        currentSplitMode = templateData.splitMode;
        document.getElementById('splitMode').value = templateData.splitMode;
      }
      
      // Restore split parts
      if (templateData.splitParts) {
        splitParts = templateData.splitParts;
      }
      
      // Restore table data
      if (templateData.tableData && templateData.tableData.length > 0) {
        const splitTableBody = document.getElementById('splitTableBody');
        const appliedSplitTable = document.getElementById('appliedSplitTable');
        
        if (splitTableBody && appliedSplitTable) {
          splitTableBody.innerHTML = templateData.tableData.map((row, index) => `
            <tr>
              <td>${row.preview}</td>
              <td>${row.sl}</td>
              <td>${row.target}</td>
              <td>${row.qty}</td>
              <td><button class="split-action-btn" onclick="editSplitPart(${index + 1}, ${row.qty})">Edit</button></td>
            </tr>
          `).join('');
          
          appliedSplitTable.classList.remove('hidden');
        }
      }
      
      toggleButtons(true);
    } catch (error) {
      console.error('Error loading template:', error);
      toggleButtons(false);
    }
  } else {
    toggleButtons(false);
  }
}
/* ================== RISK CALCULATOR & MANUAL SPLIT ================== */
function syncSliderInput(sliderId, inputId) {
  const slider = document.getElementById(sliderId);
  const input = document.getElementById(inputId);
  if (!slider || !input) return;
  
  slider.addEventListener('input', () => {
    input.value = slider.value;
    updateRiskCalculations();
  });
  
  input.addEventListener('input', () => {
    const value = parseFloat(input.value);
    if (!isNaN(value)) {
      slider.value = value;
      updateRiskCalculations();
    }
  });
}

function updateRiskCalculations() {
  const capital = parseFloat(document.getElementById('capital-input')?.value) || 100000;
  const riskPercent = parseFloat(document.getElementById('risk-input')?.value) || 2;
  const expectedReturn = parseFloat(document.getElementById('return-input')?.value) || 5;
  const quantity = parseInt(document.getElementById('qty-input')?.value) || tradeData.quantity;
  const entryPrice = parseFloat(document.getElementById('inpAvgPrice')?.value) || tradeData.avgPrice;
  const stopLoss = parseFloat(document.getElementById('inpSL')?.value) || tradeData.stopLoss;
  const target = parseFloat(document.getElementById('inpTarget')?.value) || tradeData.target;
  
  if (!entryPrice || !quantity) return;
  
  const positionValue = entryPrice * quantity;
  const capitalUsed = positionValue;
  const riskAmount = Math.abs(entryPrice - stopLoss) * quantity;
  const expectedProfit = Math.abs(target - entryPrice) * quantity;
  const rrRatio = expectedProfit / riskAmount;
  
  const updateElement = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  };
  
  updateElement('position-value', `₹${positionValue.toLocaleString()}`);
  updateElement('capital-used', `₹${capitalUsed.toLocaleString()}`);
  updateElement('risk-amount', `₹${riskAmount.toLocaleString()}`);
  updateElement('expected-profit', `₹${expectedProfit.toLocaleString()}`);
  updateElement('rr-ratio', `1:${rrRatio.toFixed(2)}`);
  updateElement('target-price', `₹${target.toFixed(2)}`);
  updateElement('stop-loss-price', `₹${stopLoss.toFixed(2)}`);
  updateElement('breakeven-price', `₹${entryPrice.toFixed(2)}`);
  
  const badge = document.getElementById('risk-badge');
  if (badge) {
    if (riskPercent <= 2) {
      badge.textContent = 'Conservative';
      badge.className = 'risk-badge conservative';
    } else if (riskPercent <= 5) {
      badge.textContent = 'Balanced';
      badge.className = 'risk-badge balanced';
    } else {
      badge.textContent = 'Aggressive';
      badge.className = 'risk-badge aggressive';
    }
  }
}

function setupPresetButtons() {
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const riskValue = parseFloat(btn.dataset.risk);
      
      const riskSlider = document.getElementById('risk-slider');
      const riskInput = document.getElementById('risk-input');
      const returnSlider = document.getElementById('return-slider');
      const returnInput = document.getElementById('return-input');
      
      if (riskSlider) riskSlider.value = riskValue;
      if (riskInput) riskInput.value = riskValue;
      
      const returnValue = riskValue * 2.5;
      if (returnSlider) returnSlider.value = returnValue;
      if (returnInput) returnInput.value = returnValue;
      
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      updateRiskCalculations();
    });
  });
}

let currentSplitMode = 'full';
let splitParts = [];

function handleSplitModeChange() {
  const modeSelect = document.getElementById('splitMode');
  const customContainer = document.getElementById('customSplitContainer');
  if (!modeSelect || !customContainer) return;
  
  const mode = modeSelect.value;
  currentSplitMode = mode;
  
  if (mode === 'custom') {
    customContainer.classList.remove('hidden');
  } else {
    customContainer.classList.add('hidden');
    updateSplitPreview();
  }
}

function validateCustomSplit() {
  const input = document.getElementById('customSplitInput');
  if (!input) return;
  
  const inputValue = input.value;
  const quantity = tradeData.quantity;
  
  if (!inputValue.trim()) {
    updateSplitPreview();
    return;
  }
  
  try {
    const parts = inputValue.split(',').map(p => parseInt(p.trim())).filter(p => p > 0);
    const total = parts.reduce((sum, p) => sum + p, 0);
    
    if (total === quantity) {
      splitParts = parts.map((qty, i) => ({ qty, label: `Part ${i + 1}` }));
      updateSplitPreview();
      input.style.borderColor = 'rgba(76, 217, 100, 0.5)';
    } else {
      input.style.borderColor = 'rgba(255, 59, 48, 0.5)';
    }
  } catch (e) {
    input.style.borderColor = 'rgba(255, 59, 48, 0.5)';
  }
}

function updateSplitPreview() {
  const appliedSplitTable = document.getElementById('appliedSplitTable');
  const splitTableBody = document.getElementById('splitTableBody');
  if (!appliedSplitTable || !splitTableBody) return;
  
  const mode = currentSplitMode;
  const quantity = tradeData.quantity;
  
  if (mode === 'full') {
    splitParts = [{ qty: quantity, label: 'Full Quantity' }];
  } else if (mode === 'half') {
    const half = Math.floor(quantity / 2);
    const remainder = quantity % 2;
    splitParts = [
      { qty: half, label: 'First Half' },
      { qty: half + remainder, label: 'Second Half' }
    ];
  }
  
  if (splitParts.length === 0) {
    appliedSplitTable.classList.add('hidden');
    return;
  }
  
  appliedSplitTable.classList.remove('hidden');
  
  splitTableBody.innerHTML = splitParts.map((part, index) => `
    <tr>
      <td>Part ${index + 1} (${part.qty} shares)</td>
      <td>₹${tradeData.stopLoss.toFixed(2)}</td>
      <td>₹${tradeData.target.toFixed(2)}</td>
      <td>${part.qty}</td>
      <td><button class="split-action-btn" onclick="editSplitPart(${index + 1}, ${part.qty})">Edit</button></td>
    </tr>
  `).join('');
}



window.savePreviewTemplate = function() {
  const splitTableBody = document.getElementById('splitTableBody');
  if (!splitTableBody || splitTableBody.children.length === 0) {
    showToast('No split data to save', 'error');
    return;
  }
  
  const templateData = {
    splitMode: currentSplitMode,
    splitParts: splitParts,
    tableData: Array.from(splitTableBody.children).map(row => {
      const cells = row.querySelectorAll('td');
      return {
        preview: cells[0]?.textContent || '',
        sl: cells[1]?.textContent || '',
        target: cells[2]?.textContent || '',
        qty: cells[3]?.textContent || ''
      };
    }),
    timestamp: Date.now()
  };
  
  localStorage.setItem('swingSplitTemplate', JSON.stringify(templateData));
  showToast('Template saved successfully!', 'success');
  document.getElementById('deleteTemplateBtn').style.display = 'inline-block';
};

window.deletePreviewTemplate = function() {
  localStorage.removeItem('swingSplitTemplate');
  showToast('Template deleted successfully!', 'success');
  document.getElementById('deleteTemplateBtn').style.display = 'none';
};

window.resetSplitTable = function() {
  const splitTableBody = document.getElementById('splitTableBody');
  const appliedSplitTable = document.getElementById('appliedSplitTable');
  
  if (splitTableBody) {
    splitTableBody.innerHTML = '';
  }
  if (appliedSplitTable) {
    appliedSplitTable.classList.add('hidden');
  }
  
  parts = [];
  currentSplitMode = 'full';
  document.getElementById('splitMode').value = 'full';
  document.getElementById('unsavedIndicator').classList.add('hidden');
  
  showToast('Split table reset successfully!', 'info');
};

/* ---------- Init ---------- */
(async function init(){
  // Load CNT rules
  loadCNTRules();
  
  // Start in AI mode by default
  modeSelect.value = 'ai';
  modeSelect.dispatchEvent(new Event('change'));
  
  // Setup AI buttons
  setupAIButtons();
  
  // Initialize risk calculator
  syncSliderInput('capital-slider', 'capital-input');
  syncSliderInput('risk-slider', 'risk-input');
  syncSliderInput('return-slider', 'return-input');
  syncSliderInput('qty-slider', 'qty-input');
  
  setupPresetButtons();
  updateRiskCalculations();
  
  // Initialize split editor
  initSplitEditor();
  
  // Load saved inputs first, then setup listeners
  loadInputsFromStorage();
  setupInputListeners();
  
  // Setup split mode handlers
  const splitModeSelect = document.getElementById('splitMode');
  if (splitModeSelect) {
    splitModeSelect.addEventListener('change', handleSplitModeChange);
  }
  
  const customSplitInput = document.getElementById('customSplitInput');
  if (customSplitInput) {
    customSplitInput.addEventListener('input', validateCustomSplit);
  }
  
  updateSplitPreview();
  
  // Load existing templates
  await loadTemplates();
  
  // Auto-save every 30 seconds
  setInterval(() => {
    if (document.getElementById('unsavedIndicator') && !document.getElementById('unsavedIndicator').classList.contains('hidden')) {
      saveInputsToStorage();
    }
  }, 30000);
  
  const defaultBtn = document.querySelector('[data-risk="2"]');
  if (defaultBtn) defaultBtn.classList.add('active');
  
  // Check if position is closed
  if (tradeData.status === 'closed') {
    const inputs = document.querySelectorAll('input, button, select');
    inputs.forEach(input => {
      if (input.id !== 'backToManual' && input.id !== 'closeBtn') {
        input.disabled = true;
        input.style.opacity = '0.5';
      }
    });
    
    const closeBtn = document.getElementById('closeBtn');
    closeBtn.textContent = 'Reopen Position';
    closeBtn.className = 'btn-ai';
    closeBtn.onclick = () => {
      if (confirm('Are you sure you want to reopen this position?')) {
        reopenPosition();
      }
    };
  }
})();

</script>
{% endblock %}