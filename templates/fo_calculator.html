{% extends "base.html" %}

{% block title %}F&O Trade Calculator v2 â€” CalculateNTrade{% endblock %}

{% block extra_css %}
<style>
  :root {
    --muted: #94a3b8;
    --card: #0b1220;
    --accent-teal: #06b6d4;
  }

  body, .right_col {
    background: linear-gradient(180deg, #030617 0%, #071022 40%, #0b1220 100%);
    color: #e6eef6;
  }

  main { max-width: 1100px; margin: 0 auto; padding: 2rem; }

  .card-bg {
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    border: 1px solid rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 6px 28px rgba(2,6,23,0.45);
  }



  label { color: #cfe9f5; font-weight: 600; display: block; margin-bottom: 0.35rem; font-size: 0.95rem; }
  .form-control {
    background: rgba(255,255,255,0.02);
    color: #e6eef6;
    border: 2px solid rgba(255,255,255,0.08);
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    width: 100%;
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }
  .form-control::placeholder { color: var(--muted); }
  .form-control:focus {
    box-shadow: 0 0 0 3px rgba(14,165,164,0.15);
    border-color: rgba(14,165,164,0.4);
    outline: none;
    background: rgba(255,255,255,0.04);
  }
  .form-control:hover {
    border-color: rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
  }

  .trade-type {
    display: inline-flex;
    gap: 0.5rem;
    background: rgba(255,255,255,0.03);
    padding: 0.5rem;
    border-radius: 0.75rem;
    border: 1px solid rgba(255,255,255,0.05);
    align-items: center;
  }

  .trade-btn {
    min-width: 100px;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    border: 2px solid transparent;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
    .buy-btn {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border-color: rgba(16, 185, 129, 0.2);
  }

  .buy-btn.active {
    background: linear-gradient(90deg, #10b981, #06b6d4);
    color: #ffffff;
    border-color: #10b981;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    transform: translateY(-1px);
  }

  .sell-btn {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.2);
  }

  .sell-btn.active {
    background: linear-gradient(90deg, #ef4444, #f87171);
    color: #ffffff;
    border-color: #ef4444;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    transform: translateY(-1px);
  }

  .trade-btn:hover {
    transform: translateY(-2px);
    filter: brightness(1.1);
  }
  .tile { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006)); border: 1px solid rgba(255,255,255,0.03); border-radius: .75rem; padding: 1rem; text-align: center; }
  .tile h3 { margin: 0; color: #cfe9f5; font-size: 0.9rem; font-weight: 700; }
  .tile .value { margin-top: .5rem; font-size: 1.15rem; font-weight: 800; }
  .green { color: #22c55e; }
  .red { color: #ef4444; }

  .actions { display: flex; gap: .6rem; flex-wrap: wrap; justify-content: flex-start; }
  .btn { padding: .5rem .8rem; border-radius: .6rem; font-weight: 700; cursor: pointer; border: 1px solid rgba(255,255,255,0.04); background: transparent; color: #e6eef6; }
  .btn-success { background: linear-gradient(90deg,#10b981,#06b6d4); color: #041024; border: none; }
  .btn-warning { background: linear-gradient(90deg,#f59e0b,#fb923c); color: #041024; border: none; }
  .btn-primary { background: linear-gradient(90deg,#3b82f6,#06b6d4); color: #041024; border: none; }
  .btn-outline { 
    background: linear-gradient(90deg, rgba(59,130,246,0.1), rgba(14,165,164,0.1)); 
    color: #38bdf8; 
    border: 2px solid rgba(59,130,246,0.3);
    font-weight: 600;
    transition: all 0.2s ease;
  }
  .btn-outline:hover {
    background: linear-gradient(90deg, rgba(59,130,246,0.2), rgba(14,165,164,0.2));
    border-color: rgba(59,130,246,0.5);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59,130,246,0.2);
  }

  .label { display: inline-block; padding: .15rem .5rem; border-radius: .4rem; font-weight: 700; font-size: .75rem; background: rgba(255,255,255,0.02); color: #cfe9f5; border: 1px solid rgba(255,255,255,0.03); }
  .label-success { background: rgba(34,197,94,0.12); color: #22c55e; border: 1px solid rgba(34,197,94,0.16); }
  .label-danger { background: rgba(239,68,68,0.10); color: #ef4444; border: 1px solid rgba(239,68,68,0.14); }
  .label-primary { background: rgba(59,130,246,0.08); color: #3b82f6; border: 1px solid rgba(59,130,246,0.12); }

  .muted-sm { color: var(--muted); font-size: .9rem; }
  .mt-2 { margin-top: .5rem; }
  .mb-3 { margin-bottom: .75rem; }

  .result-grid-two { display: grid; grid-template-columns: repeat(2,1fr); gap: .6rem; }
  .result-grid-three { display: grid; grid-template-columns: repeat(3,1fr); gap: .6rem; margin-top: .6rem; }
  @media (max-width:640px){
    .result-grid-two { grid-template-columns:1fr; }
    .result-grid-three { grid-template-columns:1fr; }
    .actions { justify-content: stretch; }
  }

  #fno-mini-chart { width:100% !important; height:100% !important; display:block; }
</style>
{% endblock %}

{% block content %}
<main id="main" tabindex="-1">
  <header class="mb-6">
    <h1 class="text-2xl font-extrabold">F&O Trade Calculator</h1>
    <p class="muted mt-1">Calculate entry, exit and risk parameters for derivatives with lot-size support.</p>
  </header>

  <section class="card-bg">
    <h2 class="mb-3">F&O Trade Parameters</h2>
    <p class="muted-sm mb-3">Enter derivative name (e.g., <code>NIFTY24DEC21000CE</code>), lot size and number of lots.</p>

      <form id="tradeForm" autocomplete="off" class="space-y-4" onsubmit="return false;">
        <div class="mb-3">
          <label>Trade Type</label>
          <div class="trade-type">
            <button type="button" class="trade-btn buy-btn active" data-type="buy">BUY â–²</button>
            <button type="button" class="trade-btn sell-btn" data-type="sell">SELL â–¼</button>
          </div>
        </div>

        <div class="mb-3">
          <label for="derivativeName">Derivative Name or Manual Entry</label>
          <input id="derivativeName" class="form-control" type="text" placeholder="e.g., NIFTY24DEC21000CE or enter manually" required />
          <p class="muted-sm mt-2">ðŸ’¡ Enter derivative name or any custom symbol for manual trading | <span class="text-green-400">Live market prices available</span></p>
        </div>

        <div class="mb-3">
          <label for="avgPrice">Average Price</label>
          <input id="avgPrice" class="form-control" type="number" step="0.01" placeholder="Enter average price" required />
        </div>

        <div class="mb-3" style="display:grid; grid-template-columns:1fr 1fr; gap:.6rem;">
          <div>
            <label for="lotSize">Lot Size</label>
            <input id="lotSize" class="form-control" type="number" value="25" />
          </div>
          <div>
            <label for="numLots">Number of Lots</label>
            <input id="numLots" class="form-control" type="number" value="1" />
          </div>
        </div>

        <div class="mb-3" style="display:grid; grid-template-columns:1fr 1fr; gap:.6rem;">
          <div>
            <label for="expectedReturn">Expected Return (%)</label>
            <input id="expectedReturn" class="form-control" type="number" step="0.1" value="2.5" />
          </div>
          <div>
            <label for="riskPercent">Risk (%)</label>
            <input id="riskPercent" class="form-control" type="number" step="0.1" value="2.5" />
          </div>
        </div>

        <div class="mb-4">
          <label for="comment">Trade Notes</label>
          <input id="comment" class="form-control" type="text" placeholder="Stock name, strategy, or comments..." />
        </div>

        <div class="actions">
          <button type="button" class="btn btn-success" id="calcBtn"><i class="fa fa-calculator"></i> Calculate</button>
          <button type="button" class="btn btn-warning" id="resetBtn"><i class="fa fa-refresh"></i> Reset</button>
           <button type="button" class="btn btn-outline" onclick="window.location.href='/saved_fno'">View Saved Trades</button>
        </div>
    </form>
  </section>

  <!-- Results Section -->
  <section id="output" style="display: none;" class="mt-8">
    <div class="bg-gradient-to-br from-slate-800/50 to-slate-900/50 border-2 border-teal-500/20 rounded-xl p-6 shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-white">F&O Trade Results</h2>
        <div id="resultTradeType" class="label label-success">BUY</div>
      </div>
      
      <!-- Lot Information -->
      <div class="result-grid-two mb-4">
        <div class="tile">
          <h3>Total Quantity</h3>
          <div class="value" id="totalQuantity">0</div>
        </div>
        <div class="tile">
          <h3>Capital Per Lot</h3>
          <div class="value" id="capitalPerLot">â‚¹0</div>
        </div>
      </div>
      
      <div class="result-grid-three">
        <div class="bg-gradient-to-br from-green-900/30 to-green-800/20 border border-green-500/30 rounded-lg p-4">
          <h3 class="text-xs text-green-300 mb-1">Target Price</h3>
          <div class="text-lg font-bold text-green-400" id="targetPrice">â‚¹0.00</div>
        </div>
        <div class="bg-gradient-to-br from-red-900/30 to-red-800/20 border border-red-500/30 rounded-lg p-4">
          <h3 class="text-xs text-red-300 mb-1">Stop-Loss Price</h3>
          <div class="text-lg font-bold text-red-400" id="stopLossPrice">â‚¹0.00</div>
        </div>
        <div class="bg-gradient-to-br from-green-900/30 to-green-800/20 border border-green-500/30 rounded-lg p-4">
          <h3 class="text-xs text-green-300 mb-1">Expected Profit</h3>
          <div class="text-lg font-bold text-green-400" id="expectedProfit">â‚¹0.00</div>
        </div>
        <div class="bg-gradient-to-br from-red-900/30 to-red-800/20 border border-red-500/30 rounded-lg p-4">
          <h3 class="text-xs text-red-300 mb-1">Maximum Risk</h3>
          <div class="text-lg font-bold text-red-400" id="maxRisk">â‚¹0.00</div>
        </div>
        <div class="bg-gradient-to-br from-blue-900/30 to-blue-800/20 border border-blue-500/30 rounded-lg p-4">
          <h3 class="text-xs text-blue-300 mb-1">Capital Used</h3>
          <div class="text-lg font-bold text-blue-400" id="capitalUsed">â‚¹0.00</div>
        </div>
        <div class="bg-gradient-to-br from-purple-900/30 to-purple-800/20 border border-purple-500/30 rounded-lg p-4">
          <h3 class="text-xs text-purple-300 mb-1">Risk-Reward Ratio</h3>
          <div class="text-lg font-bold text-purple-400" id="riskReward">0.00 : 1</div>
        </div>
      </div>
      
      <div class="mt-6 bg-gradient-to-br from-slate-700/30 to-slate-600/20 border border-slate-500/30 rounded-lg p-4">
        <h3 class="text-sm font-semibold mb-2 text-slate-300">Trade Notes</h3>
        <p id="resultComment" class="text-slate-400">No notes provided</p>
      </div>
      
      <div class="actions mt-6">
        <button type="button" class="btn btn-success" onclick="saveAndReset()"><i class="fa fa-save"></i> Save & Reset</button>
        <button type="button" class="btn btn-primary" onclick="copyResults()"><i class="fa fa-copy"></i> Copy Results</button>
        <button type="button" class="btn btn-outline" onclick="window.location.href='/saved_fno'"><i class="fa fa-list"></i> View Saved Trades</button>
      </div>
    </div>
  </section>
</main>


{% endblock %}

{% block extra_js %}
<script>
(function(){
  const $ = id => document.getElementById(id);
  let currentTradeType = 'buy';
  let resultData = null;

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.trade-btn').forEach(btn => btn.addEventListener('click', () => selectTradeType(btn.dataset.type)));
    $('calcBtn').addEventListener('click', calculate);
    $('resetBtn').addEventListener('click', resetForm);
    initMiniChart();
  });

  function selectTradeType(type) {
    currentTradeType = type;
    document.querySelectorAll('.trade-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll(`.trade-btn[data-type="${type}"]`).forEach(b => b.classList.add('active'));
  }

  function calculate() {
    const derivativeName = $('derivativeName').value.trim();
    const avgPrice = parseFloat($('avgPrice').value);
    const lotSize = parseInt($('lotSize').value) || 25;
    const numLots = parseInt($('numLots').value) || 1;
    const expectedReturn = parseFloat($('expectedReturn').value);
    const riskPercent = parseFloat($('riskPercent').value);
    const comment = $('comment').value.trim();

    if (!derivativeName || isNaN(avgPrice) || isNaN(expectedReturn) || isNaN(riskPercent)) {
      alert('Please enter derivative name and valid numbers in all fields.');
      return;
    }

    const totalQuantity = lotSize * numLots;
    const capital_used = avgPrice * totalQuantity;
    const target_profit = capital_used * (expectedReturn / 100);
    const max_risk = capital_used * (riskPercent / 100);
    const move_per_share_up = target_profit / totalQuantity;
    const move_per_share_down = max_risk / totalQuantity;

    let target_price, stop_loss_price;

    if (currentTradeType === 'buy') {
      target_price = avgPrice + move_per_share_up;
      stop_loss_price = avgPrice - move_per_share_down;
    } else {
      target_price = avgPrice - move_per_share_up;
      stop_loss_price = avgPrice + move_per_share_down;
    }

    const rr_ratio = max_risk === 0 ? 'âˆž' : (target_profit / max_risk).toFixed(2);
    const capitalPerLot = capital_used / numLots;

    resultData = {
      trade_type: currentTradeType,
      avg_price: avgPrice,
      quantity: totalQuantity,
      expected_return: expectedReturn,
      risk_percent: riskPercent,
      capital_used: capital_used,
      target_price: target_price,
      stop_loss_price: stop_loss_price,
      total_reward: target_profit,
      total_risk: max_risk,
      rr_ratio: rr_ratio,
      comment: comment || derivativeName + ' (Manual Entry)',
      symbol: derivativeName,
      derivative_name: derivativeName,
      lot_size: lotSize,
      num_lots: numLots
    };

    // Update results
    $('totalQuantity').textContent = totalQuantity;
    $('capitalPerLot').textContent = `â‚¹${capitalPerLot.toFixed(2)}`;
    $('targetPrice').textContent = `â‚¹${target_price.toFixed(2)}`;
    $('stopLossPrice').textContent = `â‚¹${stop_loss_price.toFixed(2)}`;
    $('expectedProfit').textContent = `â‚¹${target_profit.toFixed(2)}`;
    $('maxRisk').textContent = `â‚¹${max_risk.toFixed(2)}`;
    $('capitalUsed').textContent = `â‚¹${capital_used.toFixed(2)}`;
    $('riskReward').textContent = `${rr_ratio} : 1`;
    $('resultComment').textContent = comment || 'No notes provided';
    
    // Update trade type badge
    $('resultTradeType').textContent = currentTradeType.toUpperCase();
    $('resultTradeType').className = currentTradeType === 'buy' ? 'label label-success' : 'label label-danger';

    $('output').style.display = 'block';
    setTimeout(() => $('output').scrollIntoView({ behavior: 'smooth' }), 100);
  }

  function resetForm() {
    ['derivativeName','avgPrice','comment'].forEach(id => $(id).value = '');
    $('lotSize').value = 25;
    $('numLots').value = 1;
    $('expectedReturn').value = 2.5;
    $('riskPercent').value = 2.5;
    $('output').style.display = 'none';
    resultData = null;
    currentTradeType = 'buy';
    selectTradeType('buy');
  }

  async function saveAndReset() {
    if (!resultData) {
      calculate();
      if (!resultData) {
        alert('Failed to calculate. Please check inputs.');
        return;
      }
    }

    try {
      const response = await fetch('/save_fno_result', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(resultData)
      });
      
      // Check if response is HTML (redirect to login)
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('text/html')) {
        alert('Please log in to save trades.');
        window.location.href = '/login';
        return;
      }
      
      const result = await response.json();
      
      if (response.ok && result.success) {
        alert('F&O trade saved successfully!');
        resetForm();
      } else {
        console.error('Save error:', result);
        alert(result.error || result.message || 'Failed to save. Try again.');
      }
    } catch (error) {
      console.error('Error saving:', error);
      alert('Please log in to save trades.');
    }
  }

  function copyResults() {
    if (!resultData) {
      alert('Please calculate first.');
      return;
    }
    const txt = `F&O Trade\nDerivative: ${resultData.symbol}\nTrade Type: ${resultData.trade_type.toUpperCase()}\nAverage Price: â‚¹${resultData.avg_price}\nQuantity: ${resultData.quantity}\nLot Size: ${resultData.lot_size}\nExpected Return: ${resultData.expected_return}%\nRisk Percent: ${resultData.risk_percent}%\nTarget Price: â‚¹${resultData.target_price.toFixed(2)}\nStop Loss Price: â‚¹${resultData.stop_loss_price.toFixed(2)}\nExpected Profit: â‚¹${resultData.total_reward.toFixed(2)}\nMax Risk: â‚¹${resultData.total_risk.toFixed(2)}\nCapital Used: â‚¹${resultData.capital_used.toFixed(2)} (No Leverage)\nRisk-Reward Ratio: ${resultData.rr_ratio} : 1\nNotes: ${resultData.comment}`;

    navigator.clipboard.writeText(txt).then(() => {
      alert('F&O results copied to clipboard!');
    });
  }

  // Make functions global
  window.calculate = calculate;
  window.resetForm = resetForm;
  window.saveAndReset = saveAndReset;
  window.copyResults = copyResults;

  function initMiniChart() {
    const c = document.getElementById('fno-mini-chart');
    if (!c) return;
    const pts = 40;
    const series = Array.from({ length: pts }, (_, i) => 1200 + Math.sin(i / 6) * 10 + (Math.random() - 0.5) * 6);

    function render() {
      if (!window.Chart) {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
        s.onload = render;
        document.head.appendChild(s);
        return;
      }
      const ctx = c.getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels: series.map((_, i) => i + 1), datasets: [{ data: series, borderColor: '#38bdf8', tension: 0.35, pointRadius: 0, fill: true, backgroundColor: 'rgba(56,189,248,0.08)' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
      });
    }

    render();
    window.addEventListener('resize', render);
  }
})();
</script>
{% endblock %}
