{% extends "base_new_journal.html" %}

{% block title %}{% if trade %}Edit Trade{% else %}Add New Trade{% endif %} - Trading Journal{% endblock %}

{% block extra_css %}
<style>
  .form-card {
    background: var(--card);
    border: 1px solid #334155;
    border-radius: 1rem;
    padding: 2rem;
  }
  
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #e6eef6;
  }
  
  .form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 0.5rem;
    color: #e6eef6;
    font-size: 0.875rem;
    transition: all 0.3s ease;
  }
  
  .form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 0.2rem rgba(14, 165, 164, 0.25);
    background: #0f172a;
  }
  
  .form-textarea {
    resize: vertical;
    min-height: 80px;
  }
  
  .pnl-display {
    background: #0f172a;
    border: 1px solid #334155;
    color: var(--accent);
    font-weight: 600;
  }
  
  .pnl-positive {
    color: #10b981 !important;
  }
  
  .pnl-negative {
    color: #ef4444 !important;
  }
  
  .required {
    color: #ef4444;
  }
  
  .trade-type-long {
    background: rgba(16, 185, 129, 0.1);
    border-color: #10b981;
    color: #10b981;
  }
  
  .trade-type-short {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #ef4444;
  }
  
  .calculation-info {
    background: rgba(14, 165, 164, 0.1);
    border: 1px solid rgba(14, 165, 164, 0.3);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
  }
  
  .calculation-formula {
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    color: var(--accent);
  }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold">
        {% if trade %}Edit Trade{% else %}Add New Trade{% endif %}
      </h1>
      <p class="muted">{% if trade %}Update trade details{% else %}Record a new trade in your journal{% endif %}</p>
    </div>
    <a href="{{ url_for('calculatentrade.get_trades') }}" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Back to Trades
    </a>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2">
        {% for category, message in messages %}
          <div class="p-3 rounded-lg {{ 'bg-red-800 text-red-100' if category == 'error' else 'bg-green-800 text-green-100' if category == 'success' else 'bg-yellow-800 text-yellow-100' }}">
            <div class="flex items-center justify-between">
              <span>{{ message }}</span>
              <button onclick="this.parentElement.parentElement.remove()" class="text-current hover:opacity-75">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Trade Form -->
  <div class="form-card">
    <form method="POST" action="{{ url_for('calculatentrade.trade_form_post') if not trade else url_for('calculatentrade.edit_trade_form', trade_id=trade.id) }}">
      {% if trade %}
        <input type="hidden" name="trade_id" value="{{ trade.id }}">
      {% endif %}
      
      <!-- Basic Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="form-group">
          <label for="symbol" class="form-label">
            Symbol <span class="required">*</span>
          </label>
          <input type="text" class="form-input" id="symbol" name="symbol" 
                 value="{{ trade.symbol if trade else '' }}" required 
                 placeholder="e.g., RELIANCE, NIFTY, BANKNIFTY">
        </div>
        
        <div class="form-group">
          <label for="date" class="form-label">
            Trade Date <span class="required">*</span>
          </label>
          <input type="date" class="form-input" id="date" name="date" 
                 value="{{ trade.date.strftime('%Y-%m-%d') if trade else '' }}" required>
        </div>
      </div>

      <!-- Trade Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="form-group">
          <label for="trade_type" class="form-label">
            Trade Type <span class="required">*</span>
          </label>
          <select class="form-select" id="trade_type" name="trade_type" required>
            <option value="long" {{ 'selected' if trade and trade.trade_type == 'long' else '' }}>
              ðŸ“ˆ Long (Buy)
            </option>
            <option value="short" {{ 'selected' if trade and trade.trade_type == 'short' else '' }}>
              ðŸ“‰ Short (Sell)
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="quantity" class="form-label">
            Quantity <span class="required">*</span>
          </label>
          <input type="number" class="form-input" id="quantity" name="quantity" 
                 value="{{ trade.quantity if trade else '' }}" required min="1" 
                 placeholder="Number of shares/lots">
        </div>
      </div>

      <!-- Price Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="form-group">
          <label for="entry_price" class="form-label">
            Entry Price <span class="required">*</span>
          </label>
          <input type="number" class="form-input" id="entry_price" name="entry_price" 
                 value="{{ trade.entry_price if trade else '' }}" required step="0.01" min="0" 
                 placeholder="Price at which you entered">
        </div>
        
        <div class="form-group">
          <label for="exit_price" class="form-label">
            Exit Price <span class="required">*</span>
          </label>
          <input type="number" class="form-input" id="exit_price" name="exit_price" 
                 value="{{ trade.exit_price if trade else '' }}" required step="0.01" min="0" 
                 placeholder="Price at which you exited">
        </div>
      </div>

      <!-- Strategy and P&L -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="form-group">
          <label for="strategy_id" class="form-label">Strategy</label>
          <select class="form-select" id="strategy_id" name="strategy_id">
            <option value="">No Strategy Selected</option>
            {% for strategy in strategies %}
              <option value="{{ strategy.id }}" 
                      {{ 'selected' if trade and trade.strategy_id == strategy.id else '' }}>
                {{ strategy.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-group">
          <label for="pnl_display" class="form-label">P&L (Auto-calculated)</label>
          <input type="text" class="form-input pnl-display" id="pnl_display" readonly 
                 placeholder="â‚¹0.00">
        </div>
      </div>

      <!-- P&L Calculation Info -->
      <div class="calculation-info">
        <h4 class="text-sm font-semibold mb-2 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          P&L Calculation
        </h4>
        <div class="text-sm space-y-1">
          <div class="calculation-formula">
            <strong>Long:</strong> P&L = (Exit Price - Entry Price) Ã— Quantity
          </div>
          <div class="calculation-formula">
            <strong>Short:</strong> P&L = (Entry Price - Exit Price) Ã— Quantity
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="form-group">
        <label for="notes" class="form-label">Notes</label>
        <textarea class="form-textarea" id="notes" name="notes" 
                  placeholder="Add any notes about this trade - entry reason, exit reason, lessons learned, etc.">{{ trade.notes if trade else '' }}</textarea>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center justify-between pt-6 border-t border-slate-600">
        <a href="{{ url_for('calculatentrade.get_trades') }}" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Cancel
        </a>
        
        <div class="flex gap-3">
          {% if trade %}
            <button type="button" onclick="confirmDelete()" class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Delete Trade
            </button>
          {% endif %}
          
          <button type="submit" class="inline-flex items-center gap-2 px-6 py-2 bg-gradient-to-r from-teal-600 to-sky-600 text-white rounded-lg hover:from-teal-700 hover:to-sky-700 transition-all">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M5 13l4 4L19 7"/>
            </svg>
            {% if trade %}Update Trade{% else %}Save Trade{% endif %}
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <a href="{{ url_for('calculatentrade.get_strategies') }}" class="p-4 bg-[color:var(--card)] border border-slate-600 rounded-lg hover:border-teal-500 transition-colors">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-teal-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 12l2 2 4-4m6-4v16H3V4h18z"/>
          </svg>
        </div>
        <div>
          <h4 class="font-semibold">Manage Strategies</h4>
          <p class="text-sm muted">Create and edit trading strategies</p>
        </div>
      </div>
    </a>
    
    <a href="{{ url_for('calculatentrade.get_trades') }}" class="p-4 bg-[color:var(--card)] border border-slate-600 rounded-lg hover:border-sky-500 transition-colors">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-sky-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M17 16l4-4-4-4m-10 8l-4-4 4-4m13 4H4"/>
          </svg>
        </div>
        <div>
          <h4 class="font-semibold">View All Trades</h4>
          <p class="text-sm muted">Browse your trading history</p>
        </div>
      </div>
    </a>
    
    <a href="{{ url_for('calculatentrade.get_reports') }}" class="p-4 bg-[color:var(--card)] border border-slate-600 rounded-lg hover:border-emerald-500 transition-colors">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
        </div>
        <div>
          <h4 class="font-semibold">Performance Reports</h4>
          <p class="text-sm muted">Analyze your trading performance</p>
        </div>
      </div>
    </a>
  </div>
</div>

<!-- Delete Confirmation Modal -->
{% if trade %}
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-[color:var(--card)] border border-slate-600 rounded-lg max-w-md w-full mx-4">
    <div class="p-4 border-b border-slate-600">
      <h3 class="text-lg font-semibold text-red-400">Delete Trade</h3>
    </div>
    <div class="p-4">
      <p class="mb-4">Are you sure you want to delete this trade? This action cannot be undone.</p>
      <div class="flex justify-end gap-2">
        <button onclick="closeDeleteModal()" class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700 transition-colors">
          Cancel
        </button>
        <form method="POST" action="{{ url_for('calculatentrade.delete_trade', trade_id=trade.id) }}" class="inline">
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
            Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Auto-calculate P&L when prices or quantity change
function calculatePnL() {
    const entryPrice = parseFloat(document.getElementById('entry_price').value) || 0;
    const exitPrice = parseFloat(document.getElementById('exit_price').value) || 0;
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const tradeType = document.getElementById('trade_type').value;
    
    let pnl = 0;
    if (entryPrice && exitPrice && quantity) {
        if (tradeType === 'long') {
            pnl = (exitPrice - entryPrice) * quantity;
        } else {
            pnl = (entryPrice - exitPrice) * quantity;
        }
    }
    
    const pnlDisplay = document.getElementById('pnl_display');
    pnlDisplay.value = `â‚¹${pnl.toFixed(2)}`;
    
    // Update color based on profit/loss
    pnlDisplay.classList.remove('pnl-positive', 'pnl-negative');
    if (pnl > 0) {
        pnlDisplay.classList.add('pnl-positive');
    } else if (pnl < 0) {
        pnlDisplay.classList.add('pnl-negative');
    }
}

// Update trade type styling
function updateTradeTypeStyle() {
    const tradeType = document.getElementById('trade_type');
    const selectedOption = tradeType.options[tradeType.selectedIndex];
    
    tradeType.classList.remove('trade-type-long', 'trade-type-short');
    if (tradeType.value === 'long') {
        tradeType.classList.add('trade-type-long');
    } else if (tradeType.value === 'short') {
        tradeType.classList.add('trade-type-short');
    }
}

// Add event listeners
document.getElementById('entry_price').addEventListener('input', calculatePnL);
document.getElementById('exit_price').addEventListener('input', calculatePnL);
document.getElementById('quantity').addEventListener('input', calculatePnL);
document.getElementById('trade_type').addEventListener('change', function() {
    calculatePnL();
    updateTradeTypeStyle();
});

// Auto-uppercase symbol
document.getElementById('symbol').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});

// Set default date to today if creating new trade
{% if not trade %}
document.getElementById('date').value = new Date().toISOString().split('T')[0];
{% endif %}

// Delete modal functions
{% if trade %}
function confirmDelete() {
    document.getElementById('deleteModal').classList.remove('hidden');
    document.getElementById('deleteModal').classList.add('flex');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.getElementById('deleteModal').classList.remove('flex');
}
{% endif %}

// Calculate on page load if editing
document.addEventListener('DOMContentLoaded', function() {
    calculatePnL();
    updateTradeTypeStyle();
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const symbol = document.getElementById('symbol').value.trim();
    const entryPrice = parseFloat(document.getElementById('entry_price').value);
    const exitPrice = parseFloat(document.getElementById('exit_price').value);
    const quantity = parseInt(document.getElementById('quantity').value);
    
    if (!symbol) {
        alert('Please enter a symbol');
        e.preventDefault();
        return;
    }
    
    if (entryPrice <= 0 || exitPrice <= 0) {
        alert('Entry and exit prices must be greater than 0');
        e.preventDefault();
        return;
    }
    
    if (quantity <= 0) {
        alert('Quantity must be greater than 0');
        e.preventDefault();
        return;
    }
});
</script>
{% endblock %}